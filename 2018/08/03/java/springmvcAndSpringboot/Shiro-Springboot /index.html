<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script></script><script>!function(e,t,o,c,i,a,n){e.DaoVoiceObject=i,e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},e[i].l=1*new Date,a=t.createElement(o),n=t.getElementsByTagName(o)[0],a.async=1,a.src=c,a.charset="utf-8",n.parentNode.insertBefore(a,n)}(window,document,"script",("https:"==document.location.protocol?"https:":"http:")+"//widget.daovoice.io/widget/0f81ff2f.js","daovoice"),daovoice("init",{app_id:"ce3881c3"}),daovoice("update")</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="shiro,"><link rel="alternate" href="/atom.xml" title="秦贺的博客" type="application/atom+xml"><meta name="description" content="1、shiro配置类："><meta name="keywords" content="shiro"><meta property="og:type" content="article"><meta property="og:title" content="Shiro-Springboot"><meta property="og:url" content="http://yoursite.com/2018/08/03/java/springmvcAndSpringboot/Shiro-Springboot /index.html"><meta property="og:site_name" content="秦贺的博客"><meta property="og:description" content="1、shiro配置类："><meta property="og:locale" content="zh-Hans"><meta property="og:updated_time" content="2018-08-03T03:07:41.530Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Shiro-Springboot"><meta name="twitter:description" content="1、shiro配置类："><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"QinHe"},algolia:{applicationID:"FNMQKMRSYO",apiKey:"1c7c5f8f7f7c31886eede32da3f67ed3",indexName:"hexo",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://yoursite.com/2018/08/03/java/springmvcAndSpringboot/Shiro-Springboot /"><title>Shiro-Springboot | 秦贺的博客</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?df2f085ca1e73bf7063afbe80560f855";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div> <a href="https://github.com/qinheJ" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#fff;color:#151513;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg><span style="color:#000;font-weight:700;position:absolute;top:0;border:0;right:0"><br><br>&emsp;Fork me on GitHub&emsp;</span></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">秦贺的博客</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="algolia-popup popup search-popup"><div class="algolia-search"><div class="algolia-search-input-icon"><i class="fa fa-search"></i></div><div class="algolia-search-input" id="algolia-search-input"></div></div><div class="algolia-results"><div id="algolia-stats"></div><div id="algolia-hits"></div><div id="algolia-pagination" class="algolia-pagination"></div></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/03/java/springmvcAndSpringboot/Shiro-Springboot /"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="QinHe"><meta itemprop="description" content=""><meta itemprop="image" content="/images/portrait.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="秦贺的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Shiro-Springboot</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-03T11:07:41+08:00">2018-08-03</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/springmvc和springboot/" itemprop="url" rel="index"><span itemprop="name">springmvc和springboot</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">2,184</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">11</span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li><p>1、shiro配置类：</p><a id="more"></a><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="keyword">package</span> com.zhibi.xiuba.mgr.conf.shiro; </span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.credential.HashedCredentialsMatcher; </span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.pam.AuthenticationStrategy; </span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.pam.FirstSuccessfulStrategy; </span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.ModularRealmAuthorizer; </span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.cache.ehcache.EhCacheManager; </span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.realm.Realm; </span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.session.mgt.eis.SessionDAO; </span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.LifecycleBeanPostProcessor; </span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor; </span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.web.ShiroFilterFactoryBean; </span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager; </span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.servlet.Cookie; </span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.servlet.ShiroHttpSession; </span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.servlet.SimpleCookie; </span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.session.mgt.DefaultWebSessionManager; </span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger; </span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory; </span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator; </span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean; </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean; </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration; </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.DependsOn; </span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.servlet.Filter; </span><br><span class="line"><span class="keyword">import</span> java.util.*; </span><br><span class="line"> </span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment">* Shiro 配置 </span></span><br><span class="line"><span class="comment">* Apache Shiro 核心通过 Filter 来实现，就好像SpringMvc 通过DispachServlet 来主控制一样。 </span></span><br><span class="line"><span class="comment">* 既然是使用 Filter 一般也就能猜到，是通过URL规则来进行过滤和权限校验，所以我们需要定义一系列关于URL的规则和访问权限。 </span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"><span class="meta">@Configuration</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfiguration</span> </span>&#123; </span><br><span class="line"> </span><br><span class="line">	<span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass()); </span><br><span class="line">	 </span><br><span class="line">	 </span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	* 凭证匹配器 </span></span><br><span class="line"><span class="comment">	* （由于我们的密码校验交给Shiro的SimpleAuthenticationInfo进行处理了 </span></span><br><span class="line"><span class="comment">	* 所以我们需要修改下doGetAuthenticationInfo中的代码; </span></span><br><span class="line"><span class="comment">	* ） </span></span><br><span class="line"><span class="comment">	* </span></span><br><span class="line"><span class="comment">	* <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">	*/</span> </span><br><span class="line">	<span class="meta">@Bean</span>(name = <span class="string">"adminHashedCredentialsMatcher"</span>) </span><br><span class="line">	<span class="function"><span class="keyword">public</span> HashedCredentialsMatcher <span class="title">adminHashedCredentialsMatcher</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		logger.info(<span class="string">"ShiroConfiguration.adminHashedCredentialsMatcher()"</span>); </span><br><span class="line">		HashedCredentialsMatcher hashedCredentialsMatcher = <span class="keyword">new</span> HashedCredentialsMatcher(); </span><br><span class="line">		hashedCredentialsMatcher.setHashAlgorithmName(<span class="string">"md5"</span>);<span class="comment">//散列算法:这里使用MD5算法; </span></span><br><span class="line">		hashedCredentialsMatcher.setHashIterations(<span class="number">2</span>);<span class="comment">//散列的次数，当于 m比如散列两次，相d5(md5("")); </span></span><br><span class="line">		<span class="keyword">return</span> hashedCredentialsMatcher; </span><br><span class="line">	&#125; </span><br><span class="line">	 </span><br><span class="line">	<span class="meta">@Bean</span>(name = <span class="string">"customHashedCredentialsMatcher"</span>) </span><br><span class="line">	<span class="function"><span class="keyword">public</span> HashedCredentialsMatcher <span class="title">customHashedCredentialsMatcher</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		logger.info(<span class="string">"ShiroConfiguration.adminHashedCredentialsMatcher()"</span>); </span><br><span class="line">		HashedCredentialsMatcher hashedCredentialsMatcher = <span class="keyword">new</span> HashedCredentialsMatcher(); </span><br><span class="line">		hashedCredentialsMatcher.setHashAlgorithmName(<span class="string">"md5"</span>);<span class="comment">//散列算法:这里使用MD5算法; </span></span><br><span class="line">		hashedCredentialsMatcher.setHashIterations(<span class="number">1</span>);<span class="comment">//散列的次数，当于 m比如散列两次，相d5(md5("")); </span></span><br><span class="line">		<span class="keyword">return</span> hashedCredentialsMatcher; </span><br><span class="line">	&#125; </span><br><span class="line">	 </span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	* 前台身份认证realm; </span></span><br><span class="line"><span class="comment">	* </span></span><br><span class="line"><span class="comment">	* <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">	*/</span> </span><br><span class="line">	<span class="meta">@Bean</span>(name = <span class="string">"customShiroRealm"</span>) </span><br><span class="line">	<span class="function"><span class="keyword">public</span> CustomShiroRealm <span class="title">customShiroRealm</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		logger.info(<span class="string">"ShiroConfiguration.customShiroRealm()"</span>); </span><br><span class="line">		CustomShiroRealm customShiroRealm = <span class="keyword">new</span> CustomShiroRealm(); </span><br><span class="line">		customShiroRealm.setCredentialsMatcher(customHashedCredentialsMatcher()); </span><br><span class="line">		<span class="keyword">return</span> customShiroRealm; </span><br><span class="line">	&#125; </span><br><span class="line">	 </span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	* 后台身份认证realm; </span></span><br><span class="line"><span class="comment">	* </span></span><br><span class="line"><span class="comment">	* <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">	*/</span> </span><br><span class="line">	<span class="meta">@Bean</span>(name = <span class="string">"adminShiroRealm"</span>) </span><br><span class="line">	<span class="function"><span class="keyword">public</span> AdminShiroRealm <span class="title">adminShiroRealm</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		logger.info(<span class="string">"ShiroConfiguration.adminShiroRealm()"</span>); </span><br><span class="line">		AdminShiroRealm adminShiroRealm = <span class="keyword">new</span> AdminShiroRealm(); </span><br><span class="line">		adminShiroRealm.setCredentialsMatcher(adminHashedCredentialsMatcher()); </span><br><span class="line">		<span class="keyword">return</span> adminShiroRealm; </span><br><span class="line">	&#125; </span><br><span class="line">	 </span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	* shiro缓存管理器; </span></span><br><span class="line"><span class="comment">	* 需要注入对应的其它的实体类中： </span></span><br><span class="line"><span class="comment">	* 1、安全管理器：securityManager </span></span><br><span class="line"><span class="comment">	* 可见securityManager是整个shiro的核心； </span></span><br><span class="line"><span class="comment">	* </span></span><br><span class="line"><span class="comment">	* <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">	*/</span> </span><br><span class="line">	<span class="meta">@Bean</span>(name = <span class="string">"ehCacheManager"</span>) </span><br><span class="line">	<span class="function"><span class="keyword">public</span> EhCacheManager <span class="title">ehCacheManager</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		logger.info(<span class="string">"ShiroConfiguration.ehCacheManager()"</span>); </span><br><span class="line">		EhCacheManager cacheManager = <span class="keyword">new</span> EhCacheManager(); </span><br><span class="line">		cacheManager.setCacheManagerConfigFile(<span class="string">"classpath:ehcache-shiro.xml"</span>); </span><br><span class="line">		<span class="keyword">return</span> cacheManager; </span><br><span class="line">	&#125; </span><br><span class="line">	 </span><br><span class="line">	 </span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	* Shiro默认提供了三种 AuthenticationStrategy 实现： </span></span><br><span class="line"><span class="comment">	* AtLeastOneSuccessfulStrategy ：其中一个通过则成功。 </span></span><br><span class="line"><span class="comment">	* FirstSuccessfulStrategy ：其中一个通过则成功，但只返回第一个通过的Realm提供的验证信息。 </span></span><br><span class="line"><span class="comment">	* AllSuccessfulStrategy ：凡是配置到应用中的Realm都必须全部通过。 </span></span><br><span class="line"><span class="comment">	* authenticationStrategy </span></span><br><span class="line"><span class="comment">	* </span></span><br><span class="line"><span class="comment">	* <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">	*/</span> </span><br><span class="line">	<span class="meta">@Bean</span>(name = <span class="string">"authenticationStrategy"</span>) </span><br><span class="line">	<span class="function"><span class="keyword">public</span> AuthenticationStrategy <span class="title">authenticationStrategy</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		logger.info(<span class="string">"ShiroConfiguration.authenticationStrategy()"</span>); </span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> FirstSuccessfulStrategy(); </span><br><span class="line">	&#125; </span><br><span class="line">	 </span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	* <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">	* <span class="doctag">@see</span> DefaultWebSessionManager </span></span><br><span class="line"><span class="comment">	*/</span> </span><br><span class="line">	<span class="meta">@Bean</span>(name = <span class="string">"sessionManager"</span>) </span><br><span class="line">	<span class="function"><span class="keyword">public</span> DefaultWebSessionManager <span class="title">defaultWebSessionManager</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		logger.info(<span class="string">"ShiroConfiguration.defaultWebSessionManager()"</span>); </span><br><span class="line">		DefaultWebSessionManager sessionManager = <span class="keyword">new</span> DefaultWebSessionManager(); </span><br><span class="line">		sessionManager.setSessionDAO(redisSessionDAO()); </span><br><span class="line">		sessionManager.setCacheManager(ehCacheManager()); </span><br><span class="line">		<span class="comment">//单位为毫秒（1秒=1000毫秒） 3600000毫秒为1个小时 </span></span><br><span class="line">		sessionManager.setSessionValidationInterval(<span class="number">3600000</span> * <span class="number">12</span>); </span><br><span class="line">		<span class="comment">//3600000 milliseconds = 1 hour </span></span><br><span class="line">		sessionManager.setGlobalSessionTimeout(<span class="number">3600000</span> * <span class="number">12</span>); </span><br><span class="line">		sessionManager.setDeleteInvalidSessions(<span class="keyword">true</span>); </span><br><span class="line">		sessionManager.setSessionValidationSchedulerEnabled(<span class="keyword">true</span>); </span><br><span class="line">		Cookie cookie = <span class="keyword">new</span> SimpleCookie(ShiroHttpSession.DEFAULT_SESSION_ID_NAME); </span><br><span class="line">		cookie.setName(<span class="string">"WEBID"</span>); </span><br><span class="line">		cookie.setHttpOnly(<span class="keyword">true</span>); </span><br><span class="line">		sessionManager.setSessionIdCookie(cookie); </span><br><span class="line">		<span class="keyword">return</span> sessionManager; </span><br><span class="line">	&#125; </span><br><span class="line">	 </span><br><span class="line">	<span class="meta">@Bean</span> </span><br><span class="line">	<span class="function"><span class="keyword">public</span> SessionDAO <span class="title">redisSessionDAO</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		RedisSessionDAO sessionDAO = <span class="keyword">new</span> RedisSessionDAO(); </span><br><span class="line">		<span class="keyword">return</span> sessionDAO; </span><br><span class="line">	 </span><br><span class="line">	&#125; </span><br><span class="line">	 </span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	* <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">	* <span class="doctag">@see</span> org.apache.shiro.mgt.SecurityManager </span></span><br><span class="line"><span class="comment">	*/</span> </span><br><span class="line">	<span class="meta">@Bean</span>(name = <span class="string">"securityManager"</span>) </span><br><span class="line">	<span class="function"><span class="keyword">public</span> DefaultWebSecurityManager <span class="title">getDefaultWebSecurityManage</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		logger.info(<span class="string">"ShiroConfiguration.getDefaultWebSecurityManage()"</span>); </span><br><span class="line">		DefaultWebSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager(); </span><br><span class="line">		 </span><br><span class="line">		Map&lt;String, Object&gt; shiroAuthenticatorRealms = <span class="keyword">new</span> HashMap&lt;&gt;(); </span><br><span class="line">		shiroAuthenticatorRealms.put(<span class="string">"adminShiroRealm"</span>, adminShiroRealm()); </span><br><span class="line">		shiroAuthenticatorRealms.put(<span class="string">"customShiroRealm"</span>, customShiroRealm()); </span><br><span class="line">		 </span><br><span class="line">		Collection&lt;Realm&gt; shiroAuthorizerRealms = <span class="keyword">new</span> ArrayList&lt;Realm&gt;(); </span><br><span class="line">		shiroAuthorizerRealms.add(adminShiroRealm()); </span><br><span class="line">		shiroAuthorizerRealms.add(customShiroRealm()); </span><br><span class="line">		 </span><br><span class="line">		CustomModularRealmAuthenticator customModularRealmAuthenticator = <span class="keyword">new</span> CustomModularRealmAuthenticator(); </span><br><span class="line">		customModularRealmAuthenticator.setDefinedRealms(shiroAuthenticatorRealms); </span><br><span class="line">		customModularRealmAuthenticator.setAuthenticationStrategy(authenticationStrategy()); </span><br><span class="line">		securityManager.setAuthenticator(customModularRealmAuthenticator); </span><br><span class="line">		ModularRealmAuthorizer customModularRealmAuthorizer = <span class="keyword">new</span> ModularRealmAuthorizer(); </span><br><span class="line">		customModularRealmAuthorizer.setRealms(shiroAuthorizerRealms); </span><br><span class="line">		securityManager.setAuthorizer(customModularRealmAuthorizer); </span><br><span class="line">		<span class="comment">//设置realm. </span></span><br><span class="line">		<span class="comment">//securityManager.setRealm(adminShiroRealm()); </span></span><br><span class="line">		<span class="comment">//securityManager.setRealm(customShiroRealm()); </span></span><br><span class="line">		<span class="comment">//注入缓存管理器; </span></span><br><span class="line">		securityManager.setCacheManager(ehCacheManager());<span class="comment">//这个如果执行多次，也是同样的一个对象; </span></span><br><span class="line">		securityManager.setSessionManager(defaultWebSessionManager()); </span><br><span class="line">		<span class="keyword">return</span> securityManager; </span><br><span class="line">	&#125; </span><br><span class="line">	 </span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	* 开启shiro aop注解支持. </span></span><br><span class="line"><span class="comment">	* 使用代理方式;所以需要开启代码支持; </span></span><br><span class="line"><span class="comment">	* </span></span><br><span class="line"><span class="comment">	* <span class="doctag">@param</span> securityManager </span></span><br><span class="line"><span class="comment">	* <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">	*/</span> </span><br><span class="line">	<span class="meta">@Bean</span>(name = <span class="string">"authorizationAttributeSourceAdvisor"</span>) </span><br><span class="line">	<span class="function"><span class="keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="title">authorizationAttributeSourceAdvisor</span><span class="params">(DefaultWebSecurityManager securityManager)</span> </span>&#123; </span><br><span class="line">		logger.info(<span class="string">"ShiroConfiguration.authorizationAttributeSourceAdvisor()"</span>); </span><br><span class="line">		AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor = <span class="keyword">new</span> AuthorizationAttributeSourceAdvisor(); </span><br><span class="line">		authorizationAttributeSourceAdvisor.setSecurityManager(securityManager); </span><br><span class="line">		<span class="keyword">return</span> authorizationAttributeSourceAdvisor; </span><br><span class="line">	&#125; </span><br><span class="line">	 </span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	* ShiroFilterFactoryBean 处理拦截资源文件问题。 </span></span><br><span class="line"><span class="comment">	* 注意：单独一个ShiroFilterFactoryBean配置是或报错的，以为在 </span></span><br><span class="line"><span class="comment">	* 初始化ShiroFilterFactoryBean的时候需要注入：SecurityManager </span></span><br><span class="line"><span class="comment">	* Filter Chain定义说明 </span></span><br><span class="line"><span class="comment">	* 1、一个URL可以配置多个Filter，使用逗号分隔 </span></span><br><span class="line"><span class="comment">	* 2、当设置多个过滤器时，全部验证通过，才视为通过 </span></span><br><span class="line"><span class="comment">	* 3、部分过滤器可指定参数，如perms，roles </span></span><br><span class="line"><span class="comment">	*/</span> </span><br><span class="line">	<span class="meta">@Bean</span>(name = <span class="string">"shiroFilter"</span>) </span><br><span class="line">	<span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">shiroFilter</span><span class="params">(DefaultWebSecurityManager securityManager)</span> </span>&#123; </span><br><span class="line">		logger.info(<span class="string">"ShiroConfiguration.shiroFilter()"</span>); </span><br><span class="line">		ShiroFilterFactoryBean shiroFilterFactoryBean = <span class="keyword">new</span> ShiroFilterFactoryBean(); </span><br><span class="line">		<span class="comment">// 必须设置 SecurityManager </span></span><br><span class="line">		shiroFilterFactoryBean.setSecurityManager(securityManager); </span><br><span class="line">		<span class="comment">//增加自定义过滤 </span></span><br><span class="line">		Map&lt;String, Filter&gt; filters = <span class="keyword">new</span> HashMap&lt;&gt;(); </span><br><span class="line">		filters.put(<span class="string">"admin"</span>, <span class="keyword">new</span> AdminFormAuthenticationFilter()); </span><br><span class="line">		filters.put(<span class="string">"custom"</span>, <span class="keyword">new</span> CustomFormAuthenticationFilter()); </span><br><span class="line">		shiroFilterFactoryBean.setFilters(filters); </span><br><span class="line">		<span class="comment">//拦截器. </span></span><br><span class="line">		Map&lt;String, String&gt; filterChainDefinitionMap = <span class="keyword">new</span> LinkedHashMap&lt;String, String&gt;(); </span><br><span class="line">		 </span><br><span class="line">		<span class="comment">//配置退出过滤器,其中的具体的退出代码Shiro已经替我们实现了 </span></span><br><span class="line">		<span class="comment">/** </span></span><br><span class="line"><span class="comment">		* anon（匿名）org.apache.shiro.web.filter.authc.AnonymousFilter </span></span><br><span class="line"><span class="comment">		* authc（身份验证）org.apache.shiro.web.filter.authc.FormAuthenticationFilter </span></span><br><span class="line"><span class="comment">		* authcBasic（http基本验证）org.apache.shiro.web.filter.authc.BasicHttpAuthenticationFilter </span></span><br><span class="line"><span class="comment">		* logout（退出）org.apache.shiro.web.filter.authc.LogoutFilter </span></span><br><span class="line"><span class="comment">		* noSessionCreation（不创建session） org.apache.shiro.web.filter.session.NoSessionCreationFilter </span></span><br><span class="line"><span class="comment">		* perms(许可验证)  org.apache.shiro.web.filter.authz.PermissionsAuthorizationFilter </span></span><br><span class="line"><span class="comment">		* port（端口验证）org.apache.shiro.web.filter.authz.PortFilter </span></span><br><span class="line"><span class="comment">		* rest  (rest方面)  org.apache.shiro.web.filter.authz.HttpMethodPermissionFilter </span></span><br><span class="line"><span class="comment">		* roles（权限验证）org.apache.shiro.web.filter.authz.RolesAuthorizationFilter </span></span><br><span class="line"><span class="comment">		* ssl （ssl方面）org.apache.shiro.web.filter.authz.SslFilter </span></span><br><span class="line"><span class="comment">		* member （用户方面）org.apache.shiro.web.filter.authc.UserFilter </span></span><br><span class="line"><span class="comment">		* user表示用户不一定已通过认证,只要曾被Shiro记住过登录状态的用户就可以正常发起请求,比如rememberMe </span></span><br><span class="line"><span class="comment">		*/</span> </span><br><span class="line">		 </span><br><span class="line">		<span class="comment">//&lt;!-- 过滤链定义，从上向下顺序执行，一般将 /**放在最为下边 --&gt;:这是一个坑呢，一不小心代码就不好使了; </span></span><br><span class="line">		<span class="comment">//&lt;!-- authc:所有url都必须认证通过才可以访问; anon:所有url都都可以匿名访问--&gt; </span></span><br><span class="line">		filterChainDefinitionMap.put(<span class="string">"/**/login"</span>, <span class="string">"anon"</span>); </span><br><span class="line">		filterChainDefinitionMap.put(<span class="string">"/console/dashboard/zhu/**"</span>, <span class="string">"anon"</span>); </span><br><span class="line">		filterChainDefinitionMap.put(<span class="string">"/console/dashboard/phone/**"</span>, <span class="string">"anon"</span>); </span><br><span class="line">		filterChainDefinitionMap.put(<span class="string">"/**/logout"</span>, <span class="string">"logout"</span>); </span><br><span class="line">		filterChainDefinitionMap.put(<span class="string">"/member/reg"</span>, <span class="string">"anon"</span>); </span><br><span class="line">		<span class="comment">//配置记住我或认证通过可以访问的地址 </span></span><br><span class="line">		filterChainDefinitionMap.put(<span class="string">"/console/**"</span>, <span class="string">"admin"</span>); </span><br><span class="line">		filterChainDefinitionMap.put(<span class="string">"/member/**"</span>, <span class="string">"custom"</span>); </span><br><span class="line">		<span class="comment">// 如果不设置默认会自动寻找Web工程根目录下的"/login.jsp"页面 </span></span><br><span class="line">		<span class="comment">//shiroFilterFactoryBean.setLoginUrl("/member/login"); </span></span><br><span class="line">		<span class="comment">// 登录成功后要跳转的链接 </span></span><br><span class="line">		<span class="comment">//shiroFilterFactoryBean.setSuccessUrl("/member/index"); </span></span><br><span class="line">		<span class="comment">//未授权界面; </span></span><br><span class="line">		<span class="comment">//shiroFilterFactoryBean.setUnauthorizedUrl("/console/403"); </span></span><br><span class="line">		shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap); </span><br><span class="line">		<span class="keyword">return</span> shiroFilterFactoryBean; </span><br><span class="line">	&#125; </span><br><span class="line">	 </span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	* 注入LifecycleBeanPostProcessor </span></span><br><span class="line"><span class="comment">	* </span></span><br><span class="line"><span class="comment">	* <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">	*/</span> </span><br><span class="line">	<span class="meta">@Bean</span>(name = <span class="string">"lifecycleBeanPostProcessor"</span>) </span><br><span class="line">	<span class="function"><span class="keyword">public</span> LifecycleBeanPostProcessor <span class="title">lifecycleBeanPostProcessor</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		logger.info(<span class="string">"ShiroConfiguration.lifecycleBeanPostProcessor()"</span>); </span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> LifecycleBeanPostProcessor(); </span><br><span class="line">	&#125; </span><br><span class="line">	 </span><br><span class="line">	<span class="meta">@ConditionalOnMissingBean</span> </span><br><span class="line">	<span class="meta">@Bean</span>(name = <span class="string">"defaultAdvisorAutoProxyCreator"</span>) </span><br><span class="line">	<span class="meta">@DependsOn</span>(<span class="string">"lifecycleBeanPostProcessor"</span>) </span><br><span class="line">	<span class="function"><span class="keyword">public</span> DefaultAdvisorAutoProxyCreator <span class="title">getDefaultAdvisorAutoProxyCreator</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		logger.info(<span class="string">"ShiroConfiguration.getDefaultAdvisorAutoProxyCreator()"</span>); </span><br><span class="line">		DefaultAdvisorAutoProxyCreator daap = <span class="keyword">new</span> DefaultAdvisorAutoProxyCreator(); </span><br><span class="line">		daap.setProxyTargetClass(<span class="keyword">true</span>); </span><br><span class="line">		<span class="keyword">return</span> daap; </span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>2、假设现在有这样一种需求：存在两张表user和admin，分别记录普通用户和管理员的信息。并且现在要实现普通用户和管理员的分开登录，即需要两个Realm——UserRealm和AdminRealm，分别处理普通用户和管理员的验证功能。<br>但是正常情况下，当定义了两个Realm，无论是普通用户登录，还是管理员登录，都会由这两个Realm共同处理。这是因为，当配置了多个Realm时，我们通常使用的认证器是shiro自带的org.apache.shiro.authc.pam.ModularRealmAuthenticator，</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="keyword">package</span> com.zhibi.xiuba.mgr.conf.shiro; </span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.ShiroException; </span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationException; </span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationInfo; </span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationToken; </span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.pam.ModularRealmAuthenticator; </span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.realm.Realm; </span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.CollectionUtils; </span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.util.Collection; </span><br><span class="line"><span class="keyword">import</span> java.util.Map; </span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomModularRealmAuthenticator</span> <span class="keyword">extends</span> <span class="title">ModularRealmAuthenticator</span> </span>&#123; </span><br><span class="line"> </span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, Object&gt; definedRealms; </span><br><span class="line">	 </span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	* 多个realm实现 </span></span><br><span class="line"><span class="comment">	*/</span> </span><br><span class="line">	<span class="meta">@Override</span> </span><br><span class="line">	<span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doMultiRealmAuthentication</span><span class="params">(Collection&lt;Realm&gt; realms, AuthenticationToken token)</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">super</span>.doMultiRealmAuthentication(realms, token); </span><br><span class="line">	&#125; </span><br><span class="line">	</span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	* 调用单个realm执行操作 </span></span><br><span class="line"><span class="comment">	*/</span> </span><br><span class="line">	<span class="meta">@Override</span> </span><br><span class="line">	<span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doSingleRealmAuthentication</span><span class="params">(Realm realm,AuthenticationToken token)</span> </span>&#123; </span><br><span class="line">	 </span><br><span class="line">		<span class="comment">// 如果该realms不支持(不能验证)当前token </span></span><br><span class="line">		<span class="keyword">if</span> (!realm.supports(token)) &#123; </span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> ShiroException(<span class="string">"token错误!"</span>); </span><br><span class="line">		&#125; </span><br><span class="line">		AuthenticationInfo info = <span class="keyword">null</span>; </span><br><span class="line">		<span class="keyword">try</span> &#123; </span><br><span class="line">		info = realm.getAuthenticationInfo(token); </span><br><span class="line">		<span class="keyword">if</span> (info == <span class="keyword">null</span>) &#123; </span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> ShiroException(<span class="string">"token不存在!"</span>); </span><br><span class="line">		&#125; </span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123; </span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> ShiroException(<span class="string">"用户名或者密码错误!"</span>); </span><br><span class="line">		&#125; </span><br><span class="line">		<span class="keyword">return</span> info; </span><br><span class="line">	&#125; </span><br><span class="line">	 </span><br><span class="line">	 </span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	* 判断登录类型执行操作 	 </span></span><br><span class="line"><span class="comment">	*/</span> </span><br><span class="line">	<span class="meta">@Override</span> </span><br><span class="line">	<span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doAuthenticate</span><span class="params">(AuthenticationToken authenticationToken)</span><span class="keyword">throws</span> AuthenticationException </span>&#123; </span><br><span class="line">		<span class="keyword">this</span>.assertRealmsConfigured(); </span><br><span class="line">		Realm realm = <span class="keyword">null</span>; </span><br><span class="line">		CustomerAuthenticationToken token = (CustomerAuthenticationToken) authenticationToken; </span><br><span class="line">		<span class="comment">//判断是否是后台用户 </span></span><br><span class="line">		 </span><br><span class="line">		<span class="keyword">if</span> (<span class="string">"1"</span>.equals(token.getLoginType())) &#123; </span><br><span class="line">		realm = (Realm) <span class="keyword">this</span>.definedRealms.get(<span class="string">"customShiroRealm"</span>); </span><br><span class="line">		&#125;<span class="keyword">else</span>&#123; </span><br><span class="line">		realm = (Realm) <span class="keyword">this</span>.definedRealms.get(<span class="string">"adminShiroRealm"</span>); </span><br><span class="line">		&#125; </span><br><span class="line">		 </span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.doSingleRealmAuthentication(realm, authenticationToken); </span><br><span class="line">	&#125; </span><br><span class="line">	 </span><br><span class="line">	<span class="comment">/** </span></span><br><span class="line"><span class="comment">	* 判断realm是否为空 </span></span><br><span class="line"><span class="comment">	*/</span> </span><br><span class="line">	<span class="meta">@Override</span> </span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">assertRealmsConfigured</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException </span>&#123; </span><br><span class="line">		<span class="keyword">this</span>.definedRealms = <span class="keyword">this</span>.getDefinedRealms(); </span><br><span class="line">		<span class="keyword">if</span> (CollectionUtils.isEmpty(<span class="keyword">this</span>.definedRealms)) &#123; </span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> ShiroException(<span class="string">"值传递错误!"</span>); </span><br><span class="line">		&#125; </span><br><span class="line">		&#125; </span><br><span class="line">		 </span><br><span class="line">		<span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getDefinedRealms</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.definedRealms; </span><br><span class="line">		&#125; </span><br><span class="line">	 </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDefinedRealms</span><span class="params">(Map&lt;String, Object&gt; definedRealms)</span> </span>&#123; </span><br><span class="line">		<span class="keyword">this</span>.definedRealms = definedRealms; </span><br><span class="line">	&#125; </span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div><div class="my_post_copyright"><script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script><script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script><script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script><p><span>本文标题:</span><a href="/2018/08/03/java/springmvcAndSpringboot/Shiro-Springboot /">Shiro-Springboot</a></p><p><span>文章作者:</span><a href="/" title="访问 QinHe 的个人博客">QinHe</a></p><p><span>发布时间:</span>2018年08月03日 - 11:08</p><p><span>最后更新:</span>2018年08月03日 - 11:08</p></div><script>var clipboard=new Clipboard(".fa-clipboard");$(".fa-clipboard").click(function(){clipboard.on("success",function(){swal({title:"",text:"复制成功",icon:"success",showConfirmButton:!0})})})</script></div><div><div id="wechat_subscriber" style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center"> <img id="wechat_subscriber_qcode" src="/images/wechat-qcode.jpg" alt="QinHe wechat" style="width:200px;max-width:100%"><div>欢迎您扫一扫上面的微信公众号，订阅我的博客！</div></div></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/shiro/" rel="tag"><i class="fa fa-tag"></i> shiro</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2018/08/03/java/springmvcAndSpringboot/Shiro-Spring /" rel="next" title="Shiro-Spring"><i class="fa fa-chevron-left"></i> Shiro-Spring</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2018/08/03/java/springmvcAndSpringboot/spring参数校验/" rel="prev" title="spring参数校验">spring参数校验<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="addthis_inline_share_toolbox"><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5b3f66ffa7f921c2" async="async"></script></div></div></div></div><div class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zNzkxMC8xNDQ0MA=="></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><section class="site-overview-wrap sidebar-panel sidebar-panel-active"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/portrait.jpg" alt="QinHe"><p class="site-author-name" itemprop="name">QinHe</p><p class="site-description motion-element" itemprop="description">我的征途是星辰大海</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">33</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">8</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">39</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/qinheJ" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:qinheJ@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://plus.google.com/qinheJ" target="_blank" title="Google"><i class="fa fa-fw fa-google"></i> Google</a></span><span class="links-of-author-item"><a href="https://twitter.com/yourname" target="_blank" title="Twitter"><i class="fa fa-fw fa-twitter"></i> Twitter</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="http://macshuo.com/" title="MacTalk" target="_blank">MacTalk</a></li><li class="links-of-blogroll-item"> <a href="http://example.com/" title="Title" target="_blank">Title</a></li></ul></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; <span itemprop="copyrightYear">2018</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">QinHe</span><div class="powered-by"><i class="fa fa-user-md"></i> <span id="busuanzi_container_site_pv">本站访客数:<span id="busuanzi_value_site_pv"></span></span></div></div><div class="theme-info"><div class="powered-by"></div> <span class="post-count">博客全站共46.1k字</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script><script type="text/javascript" src="/lib/three/three.min.js"></script><script type="text/javascript" src="/lib/three/three-waves.min.js"></script><script type="text/javascript" src="/lib/three/canvas_lines.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">!function(e,t){var n,c=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&((n=e.createElement(t)).src="https://cdn-city.livere.com/js/embed.dist.js",n.async=!0,c.parentNode.insertBefore(n,c))}(document,"script")</script><link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css"><script src="/lib/algolia-instant-search/instantsearch.min.js"></script><script src="/js/src/algolia-search.js?v=5.1.4"></script><canvas class="fireworks" style="position:fixed;left:0;top:0;z-index:1;pointer-events:none"></canvas><script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script><script type="text/javascript" src="/js/src/fireworks.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",display:{position:"right",width:100,height:150},mobile:{show:!1}})</script></body></html><script type="text/javascript" src="/js/src/love.js"></script>