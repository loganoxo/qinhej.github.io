<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script></script><script>!function(e,t,o,c,i,a,n){e.DaoVoiceObject=i,e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},e[i].l=1*new Date,a=t.createElement(o),n=t.getElementsByTagName(o)[0],a.async=1,a.src=c,a.charset="utf-8",n.parentNode.insertBefore(a,n)}(window,document,"script",("https:"==document.location.protocol?"https:":"http:")+"//widget.daovoice.io/widget/0f81ff2f.js","daovoice"),daovoice("init",{app_id:"ce3881c3"}),daovoice("update")</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="zuul,"><link rel="alternate" href="/atom.xml" title="秦贺的博客" type="application/atom+xml"><meta name="description" content="一、微服务网关背景及简介不同的微服务一般有不同的网络地址，而外部的客户端可能需要调用多个服务的接口才能完成一个业务需求。比如一个电影购票的收集APP,可能回调用电影分类微服务，用户微服务，支付微服务等。如果客户端直接和微服务进行通信，会存在一下问题："><meta name="keywords" content="zuul"><meta property="og:type" content="article"><meta property="og:title" content="zuul笔记"><meta property="og:url" content="http://yoursite.com/2018/08/01/java/springmvcAndSpringboot/zuul笔记/index.html"><meta property="og:site_name" content="秦贺的博客"><meta property="og:description" content="一、微服务网关背景及简介不同的微服务一般有不同的网络地址，而外部的客户端可能需要调用多个服务的接口才能完成一个业务需求。比如一个电影购票的收集APP,可能回调用电影分类微服务，用户微服务，支付微服务等。如果客户端直接和微服务进行通信，会存在一下问题："><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://img-blog.csdn.net/20180801154246999?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTQyMjk2NTI=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"><meta property="og:updated_time" content="2018-08-01T08:01:58.356Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="zuul笔记"><meta name="twitter:description" content="一、微服务网关背景及简介不同的微服务一般有不同的网络地址，而外部的客户端可能需要调用多个服务的接口才能完成一个业务需求。比如一个电影购票的收集APP,可能回调用电影分类微服务，用户微服务，支付微服务等。如果客户端直接和微服务进行通信，会存在一下问题："><meta name="twitter:image" content="https://img-blog.csdn.net/20180801154246999?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTQyMjk2NTI=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"QinHe"},algolia:{applicationID:"FNMQKMRSYO",apiKey:"1c7c5f8f7f7c31886eede32da3f67ed3",indexName:"hexo",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://yoursite.com/2018/08/01/java/springmvcAndSpringboot/zuul笔记/"><title>zuul笔记 | 秦贺的博客</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?df2f085ca1e73bf7063afbe80560f855";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div> <a href="https://github.com/qinheJ" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#fff;color:#151513;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg><span style="color:#000;font-weight:700;position:absolute;top:0;border:0;right:0"><br><br>&emsp;Fork me on GitHub&emsp;</span></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">秦贺的博客</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="algolia-popup popup search-popup"><div class="algolia-search"><div class="algolia-search-input-icon"><i class="fa fa-search"></i></div><div class="algolia-search-input" id="algolia-search-input"></div></div><div class="algolia-results"><div id="algolia-stats"></div><div id="algolia-hits"></div><div id="algolia-pagination" class="algolia-pagination"></div></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/01/java/springmvcAndSpringboot/zuul笔记/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="QinHe"><meta itemprop="description" content=""><meta itemprop="image" content="/images/portrait.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="秦贺的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">zuul笔记</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-01T16:01:58+08:00">2018-08-01</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/springmvc和springboot/" itemprop="url" rel="index"><span itemprop="name">springmvc和springboot</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">1,766</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">8</span></div></div></header><div class="post-body" itemprop="articleBody"><p>一、微服务网关背景及简介<br>不同的微服务一般有不同的网络地址，而外部的客户端可能需要调用多个服务的接口才能完成一个业务需求。比如一个电影购票的收集APP,可能回调用电影分类微服务，用户微服务，支付微服务等。如果客户端直接和微服务进行通信，会存在一下问题：<br><a id="more"></a></p><ul><li><p>客户端会多次请求不同微服务，增加客户端的复杂性</p></li><li><p>存在跨域请求，在一定场景下处理相对复杂</p></li><li><p>认证复杂，每一个服务都需要独立认证</p></li><li><p>难以重构，随着项目的迭代，可能需要重新划分微服务，如果客户端直接和微服务通信，那么重构会难以实施</p></li><li><p>某些微服务可能使用了其他协议，直接访问有一定困难</p></li></ul><p>上述问题，都可以借助微服务网管解决。微服务网管是介于客户端和服务器端之间的中间层，所有的外部请求都会先经过微服务网关，架构演变成：</p><p><img src="https://img-blog.csdn.net/20180801154246999?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTQyMjk2NTI=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></p><p>这样客户端只需要和网关交互，而无需直接调用特定微服务的接口，而且方便监控，易于认证，减少客户端和各个微服务之间的交互次数。</p><p>二、zuul简介</p><p>Zuul是Netflix开源的微服务网关，他可以和Eureka,Ribbon,Hystrix等组件配合使用。Zuul组件的核心是一系列的过滤器，这些过滤器可以完成以下功能：</p><ul><li><p>身份认证和安全: 识别每一个资源的验证要求，并拒绝那些不符的请求</p></li><li><p>审查与监控：</p></li><li><p>动态路由：动态将请求路由到不同后端集群</p></li><li><p>压力测试：逐渐增加指向集群的流量，以了解性能</p></li><li><p>负载分配：为每一种负载类型分配对应容量，并弃用超出限定值的请求</p></li><li><p>静态响应处理：边缘位置进行响应，避免转发到内部集群</p></li><li><p>多区域弹性：跨域AWS Region进行请求路由，旨在实现ELB(ElasticLoad Balancing)使用多样化</p></li></ul><p>Spring Cloud对Zuul进行了整合和增强。目前，Zuul使用的默认是Apache的HTTP Client，也可以使用Rest Client，可以设置ribbon.restclient.enabled=true.</p><p>三、编写Zuul微服务网关</p><ul><li><p>1、添加依赖</p><p> Zuul的依赖肯定是要加的，如何和Eureka配合使用， Zuul需要注册到Eureka上，但是Zuul的依赖不包含Eureka Discovery客户端，所以还需要添加Eureka的客户端依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span> </span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><ul><li><p>2、启动类加上注解@EnableZuulProxy</p><p> 它默认加上了@EnableCircuitBreaker和@EnableDiscoveryClient</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span> </span><br><span class="line">	<span class="meta">@EnableZuulProxy</span> </span><br><span class="line">	<span class="meta">@EnableHystrixDashboard</span> </span><br><span class="line">	<span class="meta">@EnableTurbine</span> </span><br><span class="line">	<span class="meta">@EnableDiscoveryClient</span> </span><br><span class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZuulApplication</span> </span>&#123; </span><br><span class="line">	      <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123; </span><br><span class="line">	 </span><br><span class="line">	           SpringApplication.run(ZuulApplication.class, args); </span><br><span class="line">	      &#125; </span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure><ul><li>3、 配置application.yml</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">server:</span> </span><br><span class="line"> </span><br><span class="line"><span class="attr">  port:</span> <span class="number">8040</span> </span><br><span class="line"> </span><br><span class="line"><span class="attr">spring:</span> </span><br><span class="line"> </span><br><span class="line"><span class="attr">  application:</span> </span><br><span class="line"> </span><br><span class="line"><span class="attr">    name:</span> <span class="string">microservice-gateway-zuul</span> </span><br><span class="line"> </span><br><span class="line"><span class="attr">eureka:</span> </span><br><span class="line"> </span><br><span class="line"><span class="attr">  client:</span> </span><br><span class="line"> </span><br><span class="line"><span class="attr">    register-with-eureka:</span> <span class="literal">true</span> </span><br><span class="line"> </span><br><span class="line"><span class="attr">    fetch-registry:</span> <span class="literal">true</span> </span><br><span class="line"> </span><br><span class="line"><span class="attr">    service-url:</span> </span><br><span class="line"> </span><br><span class="line"><span class="attr">      defaultZone:</span><span class="attr">http://nicky:123abcABC@localhost:8761/eureka</span> </span><br><span class="line"> </span><br><span class="line"><span class="attr">  instance:</span> </span><br><span class="line"> </span><br><span class="line"><span class="attr">    ip-address:</span> <span class="literal">true</span> </span><br><span class="line"> </span><br><span class="line"><span class="attr">zuul:</span> </span><br><span class="line"> </span><br><span class="line"><span class="attr">  ignoredServices:</span> <span class="string">'*'</span> </span><br><span class="line"> </span><br><span class="line"><span class="attr">  routes:</span> </span><br><span class="line"> </span><br><span class="line"><span class="attr">    microservice-provider-user:</span> <span class="string">/ecom/**</span> </span><br><span class="line"> </span><br><span class="line"><span class="attr">zuul:</span> </span><br><span class="line"> </span><br><span class="line"><span class="attr"> ignoredServices:</span> <span class="string">'*'</span> <span class="string">//</span> <span class="string">忽略所有请求</span> </span><br><span class="line"> </span><br><span class="line"><span class="attr"> routes:</span> </span><br><span class="line"> </span><br><span class="line">    <span class="string">服务名:</span> <span class="string">/ecom/**</span> <span class="string">//允许将服务名映射到ecom</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  ignoredServices:</span> <span class="string">'*'</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    user-api:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/user/**</span></span><br><span class="line"><span class="attr">      stripPrefix:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">userservice</span></span><br><span class="line"><span class="attr">    task-api:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/task/**</span></span><br><span class="line"><span class="attr">      stripPrefix:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">taskservice</span></span><br><span class="line"><span class="attr">    order-api:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/order/**</span></span><br><span class="line"><span class="attr">      stripPrefix:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">orderservice</span></span><br><span class="line"><span class="attr">    pay-api:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/pay/**</span></span><br><span class="line"><span class="attr">      stripPrefix:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">payservice</span></span><br><span class="line"><span class="attr">    search-api:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/search/**</span></span><br><span class="line"><span class="attr">      stripPrefix:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">searchservice</span></span><br><span class="line"><span class="attr">    wechat-api:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/wechat/**</span></span><br><span class="line"><span class="attr">      stripPrefix:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">wechatservice</span></span><br><span class="line"><span class="attr">    wxapi-api:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/wxapi/**</span></span><br><span class="line"><span class="attr">      stripPrefix:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">wechatservice</span></span><br></pre></td></tr></table></figure><ul><li><p>4、启动Eureka，Zuul和 其他应用</p><p> 访问<a href="http://localhost:8040/ecom/user/1" target="_blank" rel="noopener">http://localhost:8040/ecom/user/1</a></p><p> 或者</p><p> <a href="http://localhost:8040/microservice-provider-user/user/1" target="_blank" rel="noopener">http://localhost:8040/microservice-provider-user/user/1</a></p><p> 都可以</p></li></ul><p>四、过滤header</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">zuul: </span><br><span class="line"> </span><br><span class="line">routes: </span><br><span class="line"> </span><br><span class="line">abc: </span><br><span class="line"> </span><br><span class="line">path: /provider/** </span><br><span class="line">service-id: microservice-provider-user </span><br><span class="line">sensitiveHeaders:Cookie,Set-Cookie,Authorization </span><br><span class="line">url: https://downstream</span><br></pre></td></tr></table></figure><p>sensitiveHeaders会过滤客户端附带的headers<br>例如：<br>sensitiveHeaders: X-ABC<br>如果客户端在发请求是带了X-ABC，那么X-ABC不会传递给下游服务</p><p>ignoredHeaders会过滤服务之间通信附带的headers<br>例如：<br>ignoredHeaders: X-ABC<br>如果客户端在发请求是带了X-ABC，那么X-ABC依然会传递给下游服务。但是如果下游服务再转发就会被过滤</p><p>还有一种情况就是客户端带了X-ABC，在ZUUL的Filter中又addZuulRequestHeader(“X-ABC”, “new”),<br>那么客户端的X-ABC将会被覆盖，此时不需要sensitiveHeaders。如果设置了sensitiveHeaders: X-ABC，那么Filter中设置的X-ABC依然不会被过滤。</p><p>五、Zuul的容错与回退<br>在Spring Cloud, Zuul默认已经整合了Hystrix, 而且如果启动了Dashborad，也可以知道Zuul对Hystrix监控的粒度是微服务，而不是某一个API; 同时也说明所有经过Zuul的请求都会被Hystrix保护起来。</p><p>为Zuul添加回退：<br>想要为Zuul添加回退，需要实现ZuulFallbackProvider接口。在实现类中，指定为哪一个微服务提供回退，并且提供一个ClientHttpResponse作为回退响应</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> classUserFallbackProvider implementsZuulFallbackProvider&#123; </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="meta">@Override</span> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getRoute</span><span class="params">()</span></span>&#123; </span><br><span class="line"> </span><br><span class="line"> <span class="comment">// 指定为哪一个微服务提供回退 </span></span><br><span class="line"> </span><br><span class="line"> <span class="keyword">return</span> <span class="string">"microservice-provider-user"</span>; </span><br><span class="line"> </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="meta">@Override</span> </span><br><span class="line"> </span><br><span class="line"><span class="function">publicClientHttpResponse <span class="title">fallbackResponse</span><span class="params">()</span> </span>&#123; </span><br><span class="line"> </span><br><span class="line"> <span class="keyword">return</span> newClientHttpResponse() &#123; </span><br><span class="line"> </span><br><span class="line"> <span class="meta">@Override</span> </span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">HttpHeadersgetHeaders</span><span class="params">()</span> </span>&#123; </span><br><span class="line"> </span><br><span class="line"><span class="comment">// 设置header </span></span><br><span class="line"> </span><br><span class="line">HttpHeaders headers = <span class="keyword">new</span> HttpHeaders(); </span><br><span class="line"> </span><br><span class="line">MediaType mediaType = <span class="keyword">new</span> MediaType(<span class="string">"application"</span>, </span><br><span class="line"> </span><br><span class="line"><span class="string">"json"</span>,Charset.forName(<span class="string">"UTF-8"</span>)); </span><br><span class="line"> </span><br><span class="line">headers.setContentType(mediaType); </span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> headers; </span><br><span class="line"> </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> <span class="meta">@Override</span> </span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">InputStreamgetBody</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123; </span><br><span class="line"> </span><br><span class="line"><span class="comment">// 响应体 </span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> newByteArrayInputStream( </span><br><span class="line"> </span><br><span class="line"><span class="string">"Usermicro-service is unavailable, please try it again later!"</span>.getBytes()); </span><br><span class="line"> </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> <span class="meta">@Override</span> </span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">StringgetStatusText</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123; </span><br><span class="line"> </span><br><span class="line"><span class="comment">// 返回状态文本 </span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.getStatusCode().getReasonPhrase(); </span><br><span class="line"> </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> <span class="meta">@Override</span> </span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">HttpStatusgetStatusCode</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123; </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> HttpStatus.OK; </span><br><span class="line"> </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> <span class="meta">@Override</span> </span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">intgetRawStatusCode</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123; </span><br><span class="line"> </span><br><span class="line"><span class="comment">// 返回数字类型的状态码 </span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.getStatusCode().value(); </span><br><span class="line"> </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> <span class="meta">@Override</span> </span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123; </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">&#125;; </span><br><span class="line"> </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重新启动Eureka Server，microservice-gateway-zuul-fallback以及microservice-provider-user</p><p>我们正常通过zuul访问microservice-provider-user微服务</p><p><a href="http://localhost:8040/microservice-provider-user/user/1" target="_blank" rel="noopener">http://localhost:8040/microservice-provider-user/user/1</a> 没有问题</p><p>然后我们关掉microservice-provider-user微服务</p><p>在访问<a href="http://localhost:8040/microservice-provider-user/user/1，则会出现User" target="_blank" rel="noopener">http://localhost:8040/microservice-provider-user/user/1，则会出现User</a> micro-service is unavailable, please try it again later!<br>而不是以前不友好的那个页面了</p><p>六、Zuul的高可用<br>Zuul的高可用非常关键，因为外部请求到后端的微服务的流量都会经过Zuul。故而在生产环境中一般都需要部署高可用的Zuul以避免单点故障</p><p>此种情况，Zuul的高可用实现比较简单，只需将多个Zuul节点注册到Eureka Server,就可以实现Zuul高可用。此时，Zuul与其他的微服务高可用没啥区别。Zuul客户端会自动从Eureka Server中查询Zuul Server的列表，并使用Ribbon负载均衡的请求Zuul集群</p></div><div><div class="my_post_copyright"><script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script><script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script><script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script><p><span>本文标题:</span><a href="/2018/08/01/java/springmvcAndSpringboot/zuul笔记/">zuul笔记</a></p><p><span>文章作者:</span><a href="/" title="访问 QinHe 的个人博客">QinHe</a></p><p><span>发布时间:</span>2018年08月01日 - 16:08</p><p><span>最后更新:</span>2018年08月01日 - 16:08</p></div><script>var clipboard=new Clipboard(".fa-clipboard");$(".fa-clipboard").click(function(){clipboard.on("success",function(){swal({title:"",text:"复制成功",icon:"success",showConfirmButton:!0})})})</script></div><div><div id="wechat_subscriber" style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center"> <img id="wechat_subscriber_qcode" src="/images/wechat-qcode.jpg" alt="QinHe wechat" style="width:200px;max-width:100%"><div>欢迎您扫一扫上面的微信公众号，订阅我的博客！</div></div></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/zuul/" rel="tag"><i class="fa fa-tag"></i> zuul</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2018/08/01/java/springmvcAndSpringboot/springboot异步/" rel="next" title="springboot异步 "><i class="fa fa-chevron-left"></i> springboot异步 </a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2018/08/01/java/springmvcAndSpringboot/AOP/" rel="prev" title="AOP ">AOP <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="addthis_inline_share_toolbox"><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5b3f66ffa7f921c2" async="async"></script></div></div></div></div><div class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zNzkxMC8xNDQ0MA=="></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><section class="site-overview-wrap sidebar-panel sidebar-panel-active"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/portrait.jpg" alt="QinHe"><p class="site-author-name" itemprop="name">QinHe</p><p class="site-description motion-element" itemprop="description">我的征途是星辰大海</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">33</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">8</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">39</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/qinheJ" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:qinheJ@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://plus.google.com/qinheJ" target="_blank" title="Google"><i class="fa fa-fw fa-google"></i> Google</a></span><span class="links-of-author-item"><a href="https://twitter.com/yourname" target="_blank" title="Twitter"><i class="fa fa-fw fa-twitter"></i> Twitter</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="http://macshuo.com/" title="MacTalk" target="_blank">MacTalk</a></li><li class="links-of-blogroll-item"> <a href="http://example.com/" title="Title" target="_blank">Title</a></li></ul></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; <span itemprop="copyrightYear">2018</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">QinHe</span><div class="powered-by"><i class="fa fa-user-md"></i> <span id="busuanzi_container_site_pv">本站访客数:<span id="busuanzi_value_site_pv"></span></span></div></div><div class="theme-info"><div class="powered-by"></div> <span class="post-count">博客全站共46.1k字</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script><script type="text/javascript" src="/lib/three/three.min.js"></script><script type="text/javascript" src="/lib/three/three-waves.min.js"></script><script type="text/javascript" src="/lib/three/canvas_lines.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">!function(e,t){var n,c=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&((n=e.createElement(t)).src="https://cdn-city.livere.com/js/embed.dist.js",n.async=!0,c.parentNode.insertBefore(n,c))}(document,"script")</script><link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css"><script src="/lib/algolia-instant-search/instantsearch.min.js"></script><script src="/js/src/algolia-search.js?v=5.1.4"></script><canvas class="fireworks" style="position:fixed;left:0;top:0;z-index:1;pointer-events:none"></canvas><script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script><script type="text/javascript" src="/js/src/fireworks.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",display:{position:"right",width:100,height:150},mobile:{show:!1}})</script></body></html><script type="text/javascript" src="/js/src/love.js"></script>