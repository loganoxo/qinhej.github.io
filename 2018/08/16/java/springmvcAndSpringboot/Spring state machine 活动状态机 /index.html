<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script></script><script>!function(e,t,o,c,i,a,n){e.DaoVoiceObject=i,e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},e[i].l=1*new Date,a=t.createElement(o),n=t.getElementsByTagName(o)[0],a.async=1,a.src=c,a.charset="utf-8",n.parentNode.insertBefore(a,n)}(window,document,"script",("https:"==document.location.protocol?"https:":"http:")+"//widget.daovoice.io/widget/0f81ff2f.js","daovoice"),daovoice("init",{app_id:"ce3881c3"}),daovoice("update")</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="spring,状态机,"><link rel="alternate" href="/atom.xml" title="秦贺的博客" type="application/atom+xml"><meta name="description" content="一、活动状态机配置"><meta name="keywords" content="spring,状态机"><meta property="og:type" content="article"><meta property="og:title" content="SpringStateMachine状态机"><meta property="og:url" content="http://yoursite.com/2018/08/16/java/springmvcAndSpringboot/Spring state machine 活动状态机 /index.html"><meta property="og:site_name" content="秦贺的博客"><meta property="og:description" content="一、活动状态机配置"><meta property="og:locale" content="zh-Hans"><meta property="og:updated_time" content="2018-08-16T13:11:57.306Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="SpringStateMachine状态机"><meta name="twitter:description" content="一、活动状态机配置"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"QinHe"},algolia:{applicationID:"FNMQKMRSYO",apiKey:"1c7c5f8f7f7c31886eede32da3f67ed3",indexName:"hexo",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://yoursite.com/2018/08/16/java/springmvcAndSpringboot/Spring state machine 活动状态机 /"><title>SpringStateMachine状态机 | 秦贺的博客</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?df2f085ca1e73bf7063afbe80560f855";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div> <a href="https://github.com/qinheJ" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#fff;color:#151513;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg><span style="color:#000;font-weight:700;position:absolute;top:0;border:0;right:0"><br><br>&emsp;Fork me on GitHub&emsp;</span></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">秦贺的博客</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="algolia-popup popup search-popup"><div class="algolia-search"><div class="algolia-search-input-icon"><i class="fa fa-search"></i></div><div class="algolia-search-input" id="algolia-search-input"></div></div><div class="algolia-results"><div id="algolia-stats"></div><div id="algolia-hits"></div><div id="algolia-pagination" class="algolia-pagination"></div></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/16/java/springmvcAndSpringboot/Spring state machine 活动状态机 /"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="QinHe"><meta itemprop="description" content=""><meta itemprop="image" content="/images/portrait.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="秦贺的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">SpringStateMachine状态机</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-16T21:11:57+08:00">2018-08-16</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/springmvc和springboot/" itemprop="url" rel="index"><span itemprop="name">springmvc和springboot</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">2,519</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">14</span></div></div></header><div class="post-body" itemprop="articleBody"><p>一、活动状态机配置<br><a id="more"></a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">package com.zhibi.xiuba.configurer; </span><br><span class="line"> </span><br><span class="line">import com.zhibi.xiuba.statemachine.EventsOnTransition; </span><br><span class="line">import com.zhibi.xiuba.statemachine.TaskEvent; </span><br><span class="line">import com.zhibi.xiuba.task.spi.domain.Task; </span><br><span class="line">import org.apache.commons.lang3.builder.ToStringBuilder; </span><br><span class="line">import org.apache.commons.lang3.builder.ToStringStyle; </span><br><span class="line">import org.slf4j.Logger; </span><br><span class="line">import org.slf4j.LoggerFactory; </span><br><span class="line">import org.springframework.aop.support.AopUtils; </span><br><span class="line">import org.springframework.beans.BeansException; </span><br><span class="line">import org.springframework.context.ApplicationContext; </span><br><span class="line">import org.springframework.context.ApplicationContextAware; </span><br><span class="line">import org.springframework.context.annotation.Bean; </span><br><span class="line">import org.springframework.context.annotation.Configuration; </span><br><span class="line">import org.springframework.core.annotation.AnnotationUtils; </span><br><span class="line">import org.springframework.statemachine.StateContext; </span><br><span class="line">import org.springframework.statemachine.StateMachine; </span><br><span class="line">import org.springframework.statemachine.action.Action; </span><br><span class="line">import org.springframework.statemachine.annotation.WithStateMachine; </span><br><span class="line">import org.springframework.statemachine.config.EnableStateMachineFactory; </span><br><span class="line">import org.springframework.statemachine.config.EnumStateMachineConfigurerAdapter; </span><br><span class="line">import org.springframework.statemachine.config.builders.StateMachineConfigurationConfigurer; </span><br><span class="line">import org.springframework.statemachine.config.builders.StateMachineStateConfigurer; </span><br><span class="line">import org.springframework.statemachine.config.builders.StateMachineTransitionConfigurer; </span><br><span class="line">import org.springframework.statemachine.listener.StateMachineListenerAdapter; </span><br><span class="line">import org.springframework.statemachine.processor.StateMachineMethodInvokerHelper; </span><br><span class="line">import org.springframework.statemachine.processor.StateMachineRuntime; </span><br><span class="line">import org.springframework.statemachine.transition.Transition; </span><br><span class="line">import org.springframework.util.ReflectionUtils; </span><br><span class="line"> </span><br><span class="line">import java.lang.reflect.Method; </span><br><span class="line">import java.util.EnumSet; </span><br><span class="line">import java.util.HashMap; </span><br><span class="line">import java.util.Map; </span><br><span class="line"> </span><br><span class="line">import static com.zhibi.xiuba.task.spi.domain.Task.TaskStatusEnum.*; </span><br><span class="line"> </span><br><span class="line">/** </span><br><span class="line">* Created by QINHE on 2017/8/14. </span><br><span class="line">*/ </span><br><span class="line">@Configuration </span><br><span class="line">@EnableStateMachineFactory(name = &quot;taskStateMachine&quot;, contextEvents = false) </span><br><span class="line">public class TaskStateMachineConfig extends EnumStateMachineConfigurerAdapter&lt;Task.TaskStatusEnum, TaskEvent&gt; implements ApplicationContextAware &#123; </span><br><span class="line"> </span><br><span class="line">private Logger logger = LoggerFactory.getLogger(this.getClass()); </span><br><span class="line"> </span><br><span class="line">private Map&lt;TaskEvent, StateMachineMethodInvokerHelper&gt; actionMap = new HashMap&lt;&gt;(); </span><br><span class="line"> </span><br><span class="line">@Override </span><br><span class="line">public void configure(StateMachineConfigurationConfigurer&lt;Task.TaskStatusEnum, TaskEvent&gt; config) throws Exception &#123; </span><br><span class="line">super.configure(config); </span><br><span class="line">config.withConfiguration().autoStartup(false).listener(new StateMachineListenerAdapter&lt;Task.TaskStatusEnum, TaskEvent&gt;() &#123; </span><br><span class="line"> </span><br><span class="line">@Override </span><br><span class="line">public void transition(Transition transition) &#123; </span><br><span class="line">logger.info(ToStringBuilder.reflectionToString(transition, ToStringStyle.MULTI_LINE_STYLE)); </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">@Override </span><br><span class="line">public void stateMachineError(StateMachine stateMachine, Exception exception) &#123; </span><br><span class="line">logger.error(exception.getLocalizedMessage(), exception); </span><br><span class="line">&#125; </span><br><span class="line">&#125;); </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">@Override </span><br><span class="line">public void configure(StateMachineStateConfigurer&lt;Task.TaskStatusEnum, TaskEvent&gt; states) throws Exception &#123; </span><br><span class="line">states.withStates().initial(WAITING_PAY).end(FINISHED) </span><br><span class="line">.end(CLOSED).end(DELETED).states(EnumSet.allOf(Task.TaskStatusEnum.class)); </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">@Override </span><br><span class="line">public void configure(StateMachineTransitionConfigurer&lt;Task.TaskStatusEnum, TaskEvent&gt; transitions) throws Exception &#123; </span><br><span class="line">transitions </span><br><span class="line">.withExternal().source(WAITING_PAY).target(DELETED).event(TaskEvent.PAY_WITH_DELETE).action(buildAction()).and() </span><br><span class="line">.withExternal().source(WAITING_PAY).target(WAITING_PAY).event(TaskEvent.NEED_PAY_MORE).action(buildAction()).and() </span><br><span class="line">.withExternal().source(WAITING_PAY).target(WAITING_AUDIT).event(TaskEvent.SUBMIT_AUDIT).action(buildAction()).and() </span><br><span class="line">.withExternal().source(WAITING_MODIFY).target(WAITING_PAY).event(TaskEvent.MODIFY_WAITING_PAY).action(buildAction()).and() </span><br><span class="line">.withExternal().source(WAITING_MODIFY).target(WAITING_AUDIT).event(TaskEvent.MODIFY_SUBMIT_AUDIT).action(buildAction()).and() </span><br><span class="line">.withExternal().source(WAITING_MODIFY).target(DELETED).event(TaskEvent.MODIFY_WITH_DELETE).action(buildAction()).and() </span><br><span class="line">.withExternal().source(WAITING_AUDIT).target(WAITING_MODIFY).event(TaskEvent.AUDIT_NOT_PASS).action(buildAction()).and() </span><br><span class="line">.withExternal().source(WAITING_AUDIT).target(UNDER_WAY).event(TaskEvent.AUDIT_PASS).action(buildAction()).and() </span><br><span class="line">.withExternal().source(UNDER_WAY).target(FINISHED).event(TaskEvent.TASK_FINISH).action(buildAction()); </span><br><span class="line"> </span><br><span class="line">//TODO:任务关闭状态这里没配置 </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">@Bean </span><br><span class="line">public Action&lt;Task.TaskStatusEnum, TaskEvent&gt; buildAction() &#123; </span><br><span class="line">return new Action&lt;Task.TaskStatusEnum, TaskEvent&gt;() &#123; </span><br><span class="line">@Override </span><br><span class="line">public void execute(StateContext&lt;Task.TaskStatusEnum, TaskEvent&gt; context) &#123; </span><br><span class="line">TaskEvent event = context.getEvent(); </span><br><span class="line">StateMachineMethodInvokerHelper helper = actionMap.get(event); </span><br><span class="line">if (helper == null) &#123; </span><br><span class="line">throw new RuntimeException(&quot;not found invoke execute!!!!event is&quot; + event.name()); </span><br><span class="line">&#125; </span><br><span class="line">StateMachineRuntime runtime = new StateMachineRuntime() &#123; </span><br><span class="line">@Override </span><br><span class="line">public StateContext getStateContext() &#123; </span><br><span class="line">return context; </span><br><span class="line">&#125; </span><br><span class="line">&#125;; </span><br><span class="line">try &#123; </span><br><span class="line">helper.process(runtime); </span><br><span class="line">&#125; catch (Exception e) &#123; </span><br><span class="line">throw new RuntimeException(e); </span><br><span class="line">&#125; </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">&#125;; </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">@Override </span><br><span class="line">public void setApplicationContext(ApplicationContext applicationContext) throws BeansException &#123; </span><br><span class="line">Map&lt;String, Object&gt; map = applicationContext.getBeansWithAnnotation(WithStateMachine.class); </span><br><span class="line">for (Map.Entry&lt;String, Object&gt; entry : map.entrySet()) &#123; </span><br><span class="line">Object bean = entry.getValue(); </span><br><span class="line">Class&lt;?&gt; beanClass = getBeanClass(bean); </span><br><span class="line">ReflectionUtils.doWithMethods(beanClass, new ReflectionUtils.MethodCallback() &#123; </span><br><span class="line">@Override </span><br><span class="line">public void doWith(Method method) throws IllegalArgumentException, IllegalAccessException &#123; </span><br><span class="line">EventsOnTransition a = AnnotationUtils.findAnnotation(method, EventsOnTransition.class); </span><br><span class="line">if (a == null) &#123; </span><br><span class="line">return; </span><br><span class="line">&#125; </span><br><span class="line">TaskEvent[] taskEvent = a.events(); </span><br><span class="line">StateMachineMethodInvokerHelper helper = new StateMachineMethodInvokerHelper(bean, method); </span><br><span class="line">for (TaskEvent event : taskEvent) &#123; </span><br><span class="line">actionMap.put(event, helper); </span><br><span class="line">&#125; </span><br><span class="line">&#125; </span><br><span class="line">&#125;); </span><br><span class="line">&#125; </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">/** </span><br><span class="line">* Gets the bean class. Will check if bean is a proxy and </span><br><span class="line">* find a class from there as target class, otherwise </span><br><span class="line">* we just get bean class. </span><br><span class="line">* </span><br><span class="line">* @param bean the bean </span><br><span class="line">* @return the bean class </span><br><span class="line">*/ </span><br><span class="line">private Class&lt;?&gt; getBeanClass(Object bean) &#123; </span><br><span class="line">Class&lt;?&gt; targetClass = AopUtils.getTargetClass(bean); </span><br><span class="line">return (targetClass != null) ? targetClass : bean.getClass(); </span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>状态转变触发（trigger）-&gt;状态机启动并加载配置-&gt;guard-&gt;action-&gt;onTransition-&gt;变成新状态</p><p> 1、项目中一般都需要打印日志，所有实体的toString()方法都是用简单的”+”，因为每”＋” 一个就会 new 一个 String 对象，这样如果系统内存小的话会暴内存。使用ToStringBuilder就可以避免暴内存这种问题。</p><p>ToStringBuilder的reflectionToString方法：</p><p>logger.info(“请求数据：”+ToStringBuilder.reflectionToString(req));</p><p>2、本项目没有使用原生的statemachine的listen注解@WithStateMachine 和@OnTransition(target = “UNPAID”)开发，而是自己做了状态迁移listener，该注解不使用OnTransition避免业务异常无法正常被状态机接收，状态还是会继续改变</p><p>3、configure(StateMachineConfigurationConfigurer&lt;Task.TaskStatusEnum, TaskEvent&gt; config)方法配置状态机的默认listener</p><p>4、configure(StateMachineStateConfigurer&lt;Task.TaskStatusEnum, TaskEvent&gt; states)配置状态机的状态枚举</p><p>5、configure(StateMachineTransitionConfigurer&lt;Task.TaskStatusEnum, TaskEvent&gt; transitions)方法配置状态机每个事件的状态迁移情况</p><p>6、setApplicationContext 方法把所有带有那个注解的类中的所有带有另一个注解的方法找出来，加入map，key是event枚举对象</p><p>7、private Class&lt;?&gt; getBeanClass(Object bean)方法，因为spring里面的bean都是通过spring代理的类，都是代理类对象，这个方法可以获取代理类的对象的实例对象。</p><p>二、状态机时间发送服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">package com.zhibi.xiuba.statemachine; </span><br><span class="line"> </span><br><span class="line">import com.zhibi.xiuba.exception.StateEventException; </span><br><span class="line">import com.zhibi.xiuba.model.ControllerResult; </span><br><span class="line">import com.zhibi.xiuba.task.spi.domain.ShowkerTask; </span><br><span class="line">import com.zhibi.xiuba.task.spi.domain.Task; </span><br><span class="line">import com.zhibi.xiuba.task.spi.enums.OperatorEnum; </span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired; </span><br><span class="line">import org.springframework.messaging.support.MessageBuilder; </span><br><span class="line">import org.springframework.statemachine.StateMachine; </span><br><span class="line">import org.springframework.statemachine.access.StateMachineAccess; </span><br><span class="line">import org.springframework.statemachine.config.StateMachineFactory; </span><br><span class="line">import org.springframework.statemachine.support.DefaultStateMachineContext; </span><br><span class="line">import org.springframework.stereotype.Service; </span><br><span class="line"> </span><br><span class="line">import java.util.HashMap; </span><br><span class="line">import java.util.List; </span><br><span class="line">import java.util.Map; </span><br><span class="line"> </span><br><span class="line">/** </span><br><span class="line">* 状态机事件发送服务 </span><br><span class="line">* &lt;p&gt; </span><br><span class="line">* 请使用本服务发送事件已保证逻辑正确性 </span><br><span class="line">* Created by RUAN on 2017/8/16. </span><br><span class="line">*/ </span><br><span class="line">@Service </span><br><span class="line">public class StateMachineInvokeService implements IStateMachineInvokeService &#123; </span><br><span class="line"> </span><br><span class="line">@Autowired </span><br><span class="line">private StateMachineFactory&lt;Task.TaskStatusEnum, TaskEvent&gt; taskStateMachine; </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">@Autowired </span><br><span class="line">private StateMachineFactory&lt;ShowkerTask.StatusEnum, ShowkerTaskEvent&gt; showKerTaskStateMachine; </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">/** </span><br><span class="line">* 发送活动事件 </span><br><span class="line">* </span><br><span class="line">* @param event活动事件 </span><br><span class="line">* @param originalTask 原始活动对象，未变更前数据 </span><br><span class="line">* @param params 扩展参数 </span><br><span class="line">*/ </span><br><span class="line">@Override </span><br><span class="line">public void sendTaskEvent(TaskEvent event, Task originalTask, OperatorEnum operator, Map&lt;String, Object&gt; params) &#123; </span><br><span class="line">if (params == null) &#123; </span><br><span class="line">params = new HashMap&lt;&gt;(); </span><br><span class="line">&#125; </span><br><span class="line">params.put(IStateMachineConstants.OPERATOR, operator.getCode()); </span><br><span class="line">sendTaskEvent(event, originalTask, params); </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">/** </span><br><span class="line">* 发送活动事件 </span><br><span class="line">* </span><br><span class="line">* @param event活动事件 </span><br><span class="line">* @param originalTask 原始活动对象，未变更前数据 </span><br><span class="line">* @param params 扩展参数 </span><br><span class="line">*/ </span><br><span class="line">@Override </span><br><span class="line">public void sendTaskEvent(TaskEvent event, Task originalTask, Map&lt;String, Object&gt; params) &#123; </span><br><span class="line">StateMachine&lt;Task.TaskStatusEnum, TaskEvent&gt; stateMachine = taskStateMachine.getStateMachine(&quot;TaskStateMachine:&quot; + originalTask.getId()); </span><br><span class="line">String taskStatus = originalTask.getTaskStatus(); </span><br><span class="line">Task.TaskStatusEnum statusEnum = Task.TaskStatusEnum.getEnumByCode(taskStatus); </span><br><span class="line">if (statusEnum == null) &#123; </span><br><span class="line">throw new RuntimeException(&quot;not found task status:&quot; + taskStatus); </span><br><span class="line">&#125; </span><br><span class="line">stateMachine.stop(); </span><br><span class="line">//启动之前恢复状态机的状态 </span><br><span class="line">List&lt;StateMachineAccess&lt;Task.TaskStatusEnum, TaskEvent&gt;&gt; withAllRegions = stateMachine.getStateMachineAccessor().withAllRegions(); </span><br><span class="line">for (StateMachineAccess&lt;Task.TaskStatusEnum, TaskEvent&gt; a : withAllRegions) &#123; </span><br><span class="line">a.resetStateMachine(new DefaultStateMachineContext&lt;&gt;(statusEnum, null, null, null, null, stateMachine.getId())); </span><br><span class="line">&#125; </span><br><span class="line">stateMachine.start(); </span><br><span class="line">stateMachine.sendEvent(MessageBuilder.withPayload(event).setHeader(IStateMachineConstants.TASK_OBJECT, originalTask).copyHeaders(params).build()); </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">/** </span><br><span class="line">* 发送拿手任务事件 </span><br><span class="line">* </span><br><span class="line">* @param event拿手任务事件 </span><br><span class="line">* @param originalTask 原始拿手任务对象，未变更前数据 </span><br><span class="line">* @param params 扩展参数 </span><br><span class="line">*/ </span><br><span class="line">@Override </span><br><span class="line">public void sendShowKerTaskEvent(ShowkerTaskEvent event, ShowkerTask originalTask, OperatorEnum operatorEnum, Map&lt;String, Object&gt; params) &#123; </span><br><span class="line">if (params == null) &#123; </span><br><span class="line">params = new HashMap&lt;&gt;(); </span><br><span class="line">&#125; </span><br><span class="line">params.put(IStateMachineConstants.OPERATOR, operatorEnum.getCode()); </span><br><span class="line">sendShowKerTaskEvent(event, originalTask, params); </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">/** </span><br><span class="line">* 发送拿手任务事件 </span><br><span class="line">* </span><br><span class="line">* @param event拿手任务事件 </span><br><span class="line">* @param originalTask 原始拿手任务对象，未变更前数据 </span><br><span class="line">* @param params 扩展参数 </span><br><span class="line">*/ </span><br><span class="line">@Override </span><br><span class="line">public void sendShowKerTaskEvent(ShowkerTaskEvent event, ShowkerTask originalTask, Map&lt;String, Object&gt; params) &#123; </span><br><span class="line">StateMachine&lt;ShowkerTask.StatusEnum, ShowkerTaskEvent&gt; stateMachine = showKerTaskStateMachine.getStateMachine(&quot;ShowkerTaskStateMachine:&quot; + originalTask.getId()); </span><br><span class="line">String taskStatus = originalTask.getStatus(); </span><br><span class="line">ShowkerTask.StatusEnum statusEnum = ShowkerTask.StatusEnum.getEnumByCode(taskStatus); </span><br><span class="line">if (statusEnum == null) &#123; </span><br><span class="line">throw new RuntimeException(&quot;not found showker task status:&quot; + taskStatus); </span><br><span class="line">&#125; </span><br><span class="line">stateMachine.stop(); </span><br><span class="line">//启动之前恢复状态机的状态 </span><br><span class="line">List&lt;StateMachineAccess&lt;ShowkerTask.StatusEnum, ShowkerTaskEvent&gt;&gt; withAllRegions = stateMachine.getStateMachineAccessor().withAllRegions(); </span><br><span class="line">for (StateMachineAccess&lt;ShowkerTask.StatusEnum, ShowkerTaskEvent&gt; a : withAllRegions) &#123; </span><br><span class="line">a.resetStateMachine(new DefaultStateMachineContext&lt;&gt;(statusEnum, null, null, null, null, stateMachine.getId())); </span><br><span class="line">&#125; </span><br><span class="line">stateMachine.start(); </span><br><span class="line">if (!stateMachine.sendEvent(MessageBuilder.withPayload(event).setHeader(IStateMachineConstants.TASK_OBJECT, originalTask).copyHeaders(params).build())) &#123; </span><br><span class="line">throw new StateEventException(ControllerResult.build(false, &quot;stateMachine_not_executed&quot;, &quot;状态机未调用&quot;)); </span><br><span class="line">&#125; </span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>三、状态迁移处理器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line">package com.zhibi.xiuba.statemachine; </span><br><span class="line"> </span><br><span class="line">import com.zhibi.xiuba.job.IJobType; </span><br><span class="line">import com.zhibi.xiuba.service.IJobService; </span><br><span class="line">import com.zhibi.xiuba.service.ITaskService; </span><br><span class="line">import com.zhibi.xiuba.task.spi.domain.Task; </span><br><span class="line">import com.zhibi.xiuba.task.spi.domain.TaskOpLog; </span><br><span class="line">import com.zhibi.xiuba.task.spi.enums.OperatorEnum; </span><br><span class="line">import com.zhibi.xiuba.utils.StringUtils; </span><br><span class="line">import org.springframework.statemachine.StateContext; </span><br><span class="line">import org.springframework.statemachine.annotation.EventHeaders; </span><br><span class="line">import org.springframework.statemachine.annotation.WithStateMachine; </span><br><span class="line"> </span><br><span class="line">import java.util.Calendar; </span><br><span class="line">import java.util.Map; </span><br><span class="line"> </span><br><span class="line">/** </span><br><span class="line"> </span><br><span class="line">* 活动状态迁移处理器 </span><br><span class="line"> </span><br><span class="line">* Created by RUAN on 2017/8/15. </span><br><span class="line"> </span><br><span class="line">* </span><br><span class="line"> </span><br><span class="line">* @see com.zhibi.xiuba.configurer.TaskStateMachineConfig </span><br><span class="line"> </span><br><span class="line">*/ </span><br><span class="line">@WithStateMachine(name = &quot;taskStateMachine&quot;) </span><br><span class="line">public class TaskTransitionHandler &#123; </span><br><span class="line"> </span><br><span class="line">private final ITaskService taskService; </span><br><span class="line"> </span><br><span class="line">private final IJobService jobService; </span><br><span class="line"> </span><br><span class="line">public TaskTransitionHandler(ITaskService taskService, </span><br><span class="line">IJobService jobService) &#123; </span><br><span class="line">this.taskService = taskService; </span><br><span class="line">this.jobService = jobService; </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">/** </span><br><span class="line"> </span><br><span class="line">* 提交审核 </span><br><span class="line"> </span><br><span class="line">*/ </span><br><span class="line">@SuppressWarnings(&quot;Duplicates&quot;) </span><br><span class="line">@EventsOnTransition(events = &#123;TaskEvent.SUBMIT_AUDIT&#125;) </span><br><span class="line">public void submitAudit(@EventHeaders Map&lt;String, Object&gt; headers, </span><br><span class="line">StateContext&lt;Task.TaskStatusEnum, TaskEvent&gt; context) &#123; </span><br><span class="line">try &#123; </span><br><span class="line">OperatorEnum operator = null; </span><br><span class="line">if (StringUtils.isNotBlank((String) context.getMessageHeaders().get(IStateMachineConstants.OPERATOR))) &#123; </span><br><span class="line">//传参中带有操作人的 </span><br><span class="line"> </span><br><span class="line">operator = OperatorEnum.getEnumByCode((String) context.getMessageHeaders().get(IStateMachineConstants.OPERATOR)); </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">Task task = (Task) headers.get(IStateMachineConstants.TASK_OBJECT); </span><br><span class="line">Long fee = (Long) headers.get(&quot;fee&quot;); </span><br><span class="line">if (task.getMarginPaid() == null) &#123; </span><br><span class="line">task.setMarginPaid(0L); </span><br><span class="line">&#125; </span><br><span class="line">TaskOpLog.TypeEnum typeEnum; </span><br><span class="line">if (task.getMarginPaid() &lt;= 0) &#123; </span><br><span class="line">typeEnum = TaskOpLog.TypeEnum.FEE_PAY; </span><br><span class="line">&#125; else &#123; </span><br><span class="line">typeEnum = TaskOpLog.TypeEnum.FEE_REPAY; </span><br><span class="line">&#125; </span><br><span class="line">if (task.getPromotionExpensesPaid() == null) &#123; </span><br><span class="line">task.setPromotionExpensesPaid(0L); </span><br><span class="line">&#125; </span><br><span class="line">if (task.getMarginSurplus() == null) &#123; </span><br><span class="line">task.setMarginSurplus(0L); </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">task.setMarginPaid(fee - (task.getPromotionExpensesNeed() - task.getPromotionExpensesPaid()) + task.getMarginPaid()); </span><br><span class="line">task.setMarginSurplus(task.getMarginPaid() - task.getMarginSurplus()); </span><br><span class="line">task.setPromotionExpensesPaid(task.getPromotionExpensesNeed()); </span><br><span class="line">task.setTaskStatus(context.getTarget().getId().getCode()); </span><br><span class="line">taskService.save(task); </span><br><span class="line">taskService.createLog(task.getId(), typeEnum, operator); </span><br><span class="line">&#125; catch (Exception e) &#123; </span><br><span class="line">e.printStackTrace(); </span><br><span class="line">throw new RuntimeException(e.getMessage()); </span><br><span class="line">&#125; </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">/** </span><br><span class="line"> </span><br><span class="line">* 待补充保证金 </span><br><span class="line"> </span><br><span class="line">*/ </span><br><span class="line">@SuppressWarnings(&quot;Duplicates&quot;) </span><br><span class="line">@EventsOnTransition(events = &#123;TaskEvent.NEED_PAY_MORE&#125;) </span><br><span class="line">public void needPayMore(@EventHeaders Map&lt;String, Object&gt; headers, </span><br><span class="line">StateContext&lt;Task.TaskStatusEnum, TaskEvent&gt; context) &#123; </span><br><span class="line">try &#123; </span><br><span class="line">OperatorEnum operator = null; </span><br><span class="line">if (StringUtils.isNotBlank((String) context.getMessageHeaders().get(IStateMachineConstants.OPERATOR))) &#123; </span><br><span class="line">//传参中带有操作人的 </span><br><span class="line"> </span><br><span class="line">operator = OperatorEnum.getEnumByCode((String) context.getMessageHeaders().get(IStateMachineConstants.OPERATOR)); </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">Task task = (Task) headers.get(IStateMachineConstants.TASK_OBJECT); </span><br><span class="line">Long fee = (Long) headers.get(&quot;fee&quot;); </span><br><span class="line">if (task.getMarginPaid() == null) &#123; </span><br><span class="line">task.setMarginPaid(0L); </span><br><span class="line">&#125; </span><br><span class="line">TaskOpLog.TypeEnum typeEnum; </span><br><span class="line">if (task.getMarginPaid() &lt;= 0) &#123; </span><br><span class="line">typeEnum = TaskOpLog.TypeEnum.FEE_PAY; </span><br><span class="line">&#125; else &#123; </span><br><span class="line">typeEnum = TaskOpLog.TypeEnum.FEE_REPAY; </span><br><span class="line">&#125; </span><br><span class="line">if (task.getPromotionExpensesPaid() == null) &#123; </span><br><span class="line">task.setPromotionExpensesPaid(0L); </span><br><span class="line">&#125; </span><br><span class="line">if (task.getMarginSurplus() == null) &#123; </span><br><span class="line">task.setMarginSurplus(0L); </span><br><span class="line">&#125; </span><br><span class="line">if (fee &lt;= (task.getPromotionExpensesNeed() - task.getPromotionExpensesPaid())) &#123; </span><br><span class="line">task.setPromotionExpensesPaid(fee + task.getPromotionExpensesPaid()); </span><br><span class="line">&#125; else &#123; </span><br><span class="line">task.setMarginPaid(fee - (task.getPromotionExpensesNeed() - task.getPromotionExpensesPaid()) + task.getMarginPaid()); </span><br><span class="line">task.setMarginSurplus(task.getMarginPaid() - task.getMarginSurplus()); </span><br><span class="line">task.setPromotionExpensesPaid(task.getPromotionExpensesNeed()); </span><br><span class="line">&#125; </span><br><span class="line">task.setTaskStatus(context.getTarget().getId().getCode()); </span><br><span class="line">taskService.save(task); </span><br><span class="line">taskService.createLog(task.getId(), typeEnum, operator); </span><br><span class="line">&#125; catch (Exception e) &#123; </span><br><span class="line">e.printStackTrace(); </span><br><span class="line">throw new RuntimeException(e.getMessage()); </span><br><span class="line">&#125; </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">/** </span><br><span class="line"> </span><br><span class="line">* 任务完成 </span><br><span class="line"> </span><br><span class="line">*/ </span><br><span class="line">@EventsOnTransition(events = TaskEvent.TASK_FINISH) </span><br><span class="line">public void taskFinish(@EventHeaders Map&lt;String, Object&gt; headers, </span><br><span class="line">StateContext&lt;Task.TaskStatusEnum, TaskEvent&gt; context) &#123; </span><br><span class="line">try &#123; </span><br><span class="line">OperatorEnum operator = null; </span><br><span class="line">if (StringUtils.isNotBlank((String) context.getMessageHeaders().get(IStateMachineConstants.OPERATOR))) &#123; </span><br><span class="line">//传参中带有操作人的 </span><br><span class="line"> </span><br><span class="line">operator = OperatorEnum.getEnumByCode((String) context.getMessageHeaders().get(IStateMachineConstants.OPERATOR)); </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line">Task task = (Task) headers.get(IStateMachineConstants.TASK_OBJECT); </span><br><span class="line">task.setTaskStatus(context.getTarget().getId().getCode()); </span><br><span class="line">task.setSettlementStatus(Task.SettlementStatusEnum.WAITING_SETTLEMENT.getCode()); </span><br><span class="line">Calendar calendar = Calendar.getInstance(); </span><br><span class="line">task.setFinishTime(calendar.getTime()); </span><br><span class="line">taskService.save(task); </span><br><span class="line">taskService.createLog(task.getId(), TaskOpLog.TypeEnum.FINISH, operator); </span><br><span class="line">taskService.moveToEsAndIndexCacheHistory(task); </span><br><span class="line">jobService.submitTaskJob(task.getId(), IJobType.TASK_AUTO_AUDIT_SHOWKER, 48); </span><br><span class="line">&#125; catch (Exception e) &#123; </span><br><span class="line">e.printStackTrace(); </span><br><span class="line">throw new RuntimeException(e.getMessage()); </span><br><span class="line">&#125; </span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div><div class="my_post_copyright"><script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script><script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script><script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script><p><span>本文标题:</span><a href="/2018/08/16/java/springmvcAndSpringboot/Spring state machine 活动状态机 /">SpringStateMachine状态机</a></p><p><span>文章作者:</span><a href="/" title="访问 QinHe 的个人博客">QinHe</a></p><p><span>发布时间:</span>2018年08月16日 - 21:08</p><p><span>最后更新:</span>2018年08月16日 - 21:08</p></div><script>var clipboard=new Clipboard(".fa-clipboard");$(".fa-clipboard").click(function(){clipboard.on("success",function(){swal({title:"",text:"复制成功",icon:"success",showConfirmButton:!0})})})</script></div><div><div id="wechat_subscriber" style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center"> <img id="wechat_subscriber_qcode" src="/images/wechat-qcode.jpg" alt="QinHe wechat" style="width:200px;max-width:100%"><div>欢迎您扫一扫上面的微信公众号，订阅我的博客！</div></div></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/spring/" rel="tag"><i class="fa fa-tag"></i> spring</a><a href="/tags/状态机/" rel="tag"><i class="fa fa-tag"></i> 状态机</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2018/08/15/java/javaweb技术/Docker容器基础知识/" rel="next" title="Docker容器基础知识"><i class="fa fa-chevron-left"></i> Docker容器基础知识</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2018/08/16/java/业务逻辑/类似于美团红包的功能/" rel="prev" title="类似于美团红包的功能">类似于美团红包的功能<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="addthis_inline_share_toolbox"><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5b3f66ffa7f921c2" async="async"></script></div></div></div></div><div class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zNzkxMC8xNDQ0MA=="></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><section class="site-overview-wrap sidebar-panel sidebar-panel-active"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/portrait.jpg" alt="QinHe"><p class="site-author-name" itemprop="name">QinHe</p><p class="site-description motion-element" itemprop="description">我的征途是星辰大海</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">31</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">8</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">35</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/qinheJ" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:qinheJ@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://plus.google.com/qinheJ" target="_blank" title="Google"><i class="fa fa-fw fa-google"></i> Google</a></span><span class="links-of-author-item"><a href="https://twitter.com/yourname" target="_blank" title="Twitter"><i class="fa fa-fw fa-twitter"></i> Twitter</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="http://macshuo.com/" title="MacTalk" target="_blank">MacTalk</a></li><li class="links-of-blogroll-item"> <a href="http://example.com/" title="Title" target="_blank">Title</a></li></ul></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; <span itemprop="copyrightYear">2018</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">QinHe</span><div class="powered-by"><i class="fa fa-user-md"></i> <span id="busuanzi_container_site_pv">本站访客数:<span id="busuanzi_value_site_pv"></span></span></div></div><div class="theme-info"><div class="powered-by"></div> <span class="post-count">博客全站共42.8k字</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script><script type="text/javascript" src="/lib/three/three.min.js"></script><script type="text/javascript" src="/lib/three/three-waves.min.js"></script><script type="text/javascript" src="/lib/three/canvas_lines.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">!function(e,t){var n,c=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&((n=e.createElement(t)).src="https://cdn-city.livere.com/js/embed.dist.js",n.async=!0,c.parentNode.insertBefore(n,c))}(document,"script")</script><link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css"><script src="/lib/algolia-instant-search/instantsearch.min.js"></script><script src="/js/src/algolia-search.js?v=5.1.4"></script><canvas class="fireworks" style="position:fixed;left:0;top:0;z-index:1;pointer-events:none"></canvas><script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script><script type="text/javascript" src="/js/src/fireworks.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",display:{position:"right",width:100,height:150},mobile:{show:!1}})</script></body></html><script type="text/javascript" src="/js/src/love.js"></script>