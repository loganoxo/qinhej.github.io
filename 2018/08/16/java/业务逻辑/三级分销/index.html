<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script></script><script>!function(e,t,o,c,i,a,n){e.DaoVoiceObject=i,e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},e[i].l=1*new Date,a=t.createElement(o),n=t.getElementsByTagName(o)[0],a.async=1,a.src=c,a.charset="utf-8",n.parentNode.insertBefore(a,n)}(window,document,"script",("https:"==document.location.protocol?"https:":"http:")+"//widget.daovoice.io/widget/0f81ff2f.js","daovoice"),daovoice("init",{app_id:"ce3881c3"}),daovoice("update")</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="三级分销,"><link rel="alternate" href="/atom.xml" title="秦贺的博客" type="application/atom+xml"><meta name="description" content="通过“三级分销”的形式，形成拿手端的裂变，提高拿手注册转化的积极性！一、业务模式拿手端的“三级分销”，其基础业务模式参考商家端，通过邀请注册的形式，形成3级关系，"><meta name="keywords" content="三级分销"><meta property="og:type" content="article"><meta property="og:title" content="三级分销"><meta property="og:url" content="http://yoursite.com/2018/08/16/java/业务逻辑/三级分销/index.html"><meta property="og:site_name" content="秦贺的博客"><meta property="og:description" content="通过“三级分销”的形式，形成拿手端的裂变，提高拿手注册转化的积极性！一、业务模式拿手端的“三级分销”，其基础业务模式参考商家端，通过邀请注册的形式，形成3级关系，"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://img-blog.csdn.net/20180816110115375?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTQyMjk2NTI=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"><meta property="og:image" content="https://img-blog.csdn.net/20180816110150991?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTQyMjk2NTI=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"><meta property="og:image" content="https://img-blog.csdn.net/20180816110209671?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTQyMjk2NTI=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"><meta property="og:updated_time" content="2018-08-16T13:55:54.996Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="三级分销"><meta name="twitter:description" content="通过“三级分销”的形式，形成拿手端的裂变，提高拿手注册转化的积极性！一、业务模式拿手端的“三级分销”，其基础业务模式参考商家端，通过邀请注册的形式，形成3级关系，"><meta name="twitter:image" content="https://img-blog.csdn.net/20180816110115375?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTQyMjk2NTI=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"QinHe"},algolia:{applicationID:"FNMQKMRSYO",apiKey:"1c7c5f8f7f7c31886eede32da3f67ed3",indexName:"hexo",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://yoursite.com/2018/08/16/java/业务逻辑/三级分销/"><title>三级分销 | 秦贺的博客</title><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?df2f085ca1e73bf7063afbe80560f855";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div> <a href="https://github.com/qinheJ" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#fff;color:#151513;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg><span style="color:#000;font-weight:700;position:absolute;top:0;border:0;right:0"><br><br>&emsp;Fork me on GitHub&emsp;</span></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">秦贺的博客</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="algolia-popup popup search-popup"><div class="algolia-search"><div class="algolia-search-input-icon"><i class="fa fa-search"></i></div><div class="algolia-search-input" id="algolia-search-input"></div></div><div class="algolia-results"><div id="algolia-stats"></div><div id="algolia-hits"></div><div id="algolia-pagination" class="algolia-pagination"></div></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/16/java/业务逻辑/三级分销/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="QinHe"><meta itemprop="description" content=""><meta itemprop="image" content="/images/portrait.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="秦贺的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">三级分销</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-16T21:55:54+08:00">2018-08-16</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/业务逻辑/" itemprop="url" rel="index"><span itemprop="name">业务逻辑</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">3,842</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">19</span></div></div></header><div class="post-body" itemprop="articleBody"><p>通过“三级分销”的形式，形成拿手端的裂变，提高拿手注册转化的积极性！<br>一、业务模式<br>拿手端的“三级分销”，其基础业务模式参考商家端，通过邀请注册的形式，形成3级关系，<a id="more"></a> 在关系网内的用户产生返利行为时，可以按照进行获得返利的业务模式。</p><ul><li><p>平台角色设定：<br>平台设定四个角色：“大师傅”、“师傅”、“徒弟”以及“徒孙”；<br>只有徒弟的人数累计满30人（即该用户的子集）才可获得“大师傅”资格；</p></li><li><p>返利类型<br>返利的类型分为两种，一种是注册返利，一种是完成活动返利；</p></li><li><p>触发返利的条件：<br>通过邀请链接注册成功即可触发注册返利；<br>由于拿手在平台上不产生消费行为，且可能存在中途放弃任务的行为，因此完成活动返利条件设定为商家通过该拿手的买家秀，向其返款时；</p></li><li><p>返利行为：<br>徒弟和徒孙都会向其上一级邀请人以及大师傅进行返利，比如徒孙会向徒弟返利，同时也会向大师傅返利；<br>徒弟在返利时，由于其上一级就是大师傅，因此徒弟会向大师傅返利2次；<br>徒孙是支持多层级的，如下图所示，徒孙B2可能存在徒孙2.1甚至徒孙n这样的多层级关系，因此徒孙在计算返利时，按照徒孙n-1（即该徒孙的上一次邀请人）以及大师傅进行返利；<br>在未成为大师傅之前，只能获得上一级的返利，大师傅返利无法获得；<br>用户成为大师傅后，其自身的活动行为不会对任何人产生返利行为；<br>返利来源与计算<br>拿手的返利来源建议全部由平台支出，商家端因为会员等级的不同，推广费、增值费等平台营收费用的收取规则也不一样，很难做到统一，因此拿手的返利来源建议统一由平台进行支出；<br>返利的金额按照固定金额的进行操作，同时该金额需要支持可配置，可以参考下方表格：</p><p> |返利行为|对象与金额|<br> | —— | —— |<br> |注册返利|上一级（0.5）/大师傅（0.2）|<br> |活动返利|上一级（1）/大师傅（0.5）|</p></li></ul><ul><li>关系脱离<br>当某个徒弟或者徒孙的下一级人数满30人时，该徒弟或徒孙则自动升级为大师傅，并自动从原有的体系中脱离（包括该用户下的所有子集），后续产生的返利行为也从原体系中脱离；</li></ul><p><img src="https://img-blog.csdn.net/20180816110115375?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTQyMjk2NTI=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></p><ul><li>账单与交易记录<br>每个用户通过该体系收到的返利金额，沿用之前推广大师傅的设定，全部统一先到用户的推广金额里，然后统一提取到该用户的账户余额里；<br>提取账户余额的限制和之前保持一致，同样是5元起提；<br>系统账单同样沿用之前的设定，只有当用户将该金额提取到账户余额中时，才生成对应的账单记录；<br>用户获得的每一笔返利，系统都需要进行记录，包括返利的时间、金额、类型、返利的对象等；</li></ul><p>二、界面部分改动<br>拿手端只增加手机端，PC端暂不操作，主要调整页面为推广大师傅主界面和查看详情页，设计稿待调整，原型如下。</p><p><img src="https://img-blog.csdn.net/20180816110150991?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTQyMjk2NTI=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></p><p><img src="https://img-blog.csdn.net/20180816110209671?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTQyMjk2NTI=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述"></p><p>三、系统设计：</p><ul><li>实体类设计：</li></ul><p>1、邀请关系表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">package com.zhibi.xiuba.user.spi.model;</span><br><span class="line"></span><br><span class="line">import com.zhibi.xiuba.domain.BaseDomain;</span><br><span class="line">import com.zhibi.xiuba.model.BaseEnum;</span><br><span class="line">import org.hibernate.annotations.GenericGenerator;</span><br><span class="line"></span><br><span class="line">import javax.persistence.*;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">* Created by qinhe_admin on 2017/9/25.</span><br><span class="line">*/</span><br><span class="line">@Entity</span><br><span class="line">@Table(name = &quot;xb_us_showker_invitation&quot;, indexes = &#123;@Index(name = &quot;father_distance&quot;, columnList = &quot;father_id,distance&quot;, unique = true)&#125;)</span><br><span class="line">public class ShowkerInvitation extends BaseDomain &#123;</span><br><span class="line">   private static final long serialVersionUID = 7228910123994809290L;</span><br><span class="line">   @Id</span><br><span class="line">   @GeneratedValue(generator = &quot;id_generator&quot;)</span><br><span class="line">   @GenericGenerator(name = &quot;id_generator&quot;, strategy = &quot;redis_id&quot;)</span><br><span class="line">   private Long id;</span><br><span class="line"></span><br><span class="line">   /**</span><br><span class="line">    * 被邀请人ID</span><br><span class="line">    */</span><br><span class="line">   @Column(unique = true)</span><br><span class="line">   private Long userId;</span><br><span class="line"></span><br><span class="line">   /**</span><br><span class="line">    * 邀请人ID</span><br><span class="line">    */</span><br><span class="line">   @Column(name = &quot;father_id&quot;)</span><br><span class="line">   private Long fatherId;</span><br><span class="line"></span><br><span class="line">   /**</span><br><span class="line">    * 祖先（子孙满30个的祖先）</span><br><span class="line">    */</span><br><span class="line">   private Long forefatherId;</span><br><span class="line"></span><br><span class="line">   /**</span><br><span class="line">    * 与祖先差了多少个层级，最小是1</span><br><span class="line">    */</span><br><span class="line">   @Column(name = &quot;distance&quot;)</span><br><span class="line">   private Integer distance;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">get、set方法省略</span><br></pre></td></tr></table></figure><p>2、业务逻辑设计：<br>关系的建立：注册<br>奖励的触发：注册和拿手完成活动<br>奖励的触发涉及到对账户和金额的操作，需要做到必达性，所以需要做在消息队列里面，我用的是rocketmq做消息队列，mq有一个好处，就是他自身就支持消息回查，并且会自动重试，如果金额处理有问题，返回一个ConsumeConcurrentlyStatus.RECONSUME_LATER;mq会间隔一段时间重复去处理这个业务，如果处理金额成功，则直接返回一个CONSUME_SUCCESS就可以了</p><p>3、邀请关系的建立<br>这里有一个很麻烦的业务处理，需要在注册的时候就建立关系，和主要的注册方法是异步处理，保证注册成功并迅速完成。注册的时候会从页面上带上一个邀请商家id的请求头，在后端获取到这个请求头，并找到邀请人的用户信息，然后建立关系。如果只有一层关系就这样就可以了，但是我们三级分销是要有多层关系的，返款的时候不但需要找到邀请人，还要找到大师傅（所有父集里面邀请满足30人的用户），有人可能觉得直接循环去遍历父集就好了，但是这样对性能影响特别大，而且这种操作钱的操作都是重要的业务逻辑，不能这么耗性能。所以需要在每个人注册的时候不但要存储邀请人和和自己的邀请关系，同时要查看邀请人是否满足了大师傅的条件，如果满足，则对这个大师傅的所有子集都打上这个大师傅的标签。主要业务逻辑代码如下：</p><p>①主要注册代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> User <span class="title">signUp</span><span class="params">(User user, UserAccount userAccount, Long inviterId, String wechatPlatformType, String wechatOpenId, Long boostTaskApplyId)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        User signUp = userService.signUp(user, userAccount, inviterId, wechatPlatformType, wechatOpenId, boostTaskApplyId);</span><br><span class="line">        <span class="keyword">if</span> (signUp != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String channelSource = signUp.getChannelSource();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//处理大师傅邀请</span></span><br><span class="line">            <span class="keyword">if</span> (inviterId != <span class="keyword">null</span>) &#123;</span><br><span class="line">                User inviter = userService.get(inviterId);</span><br><span class="line">                <span class="keyword">if</span> (UserService.CHANNEL_SOURCE_DSF.equalsIgnoreCase(channelSource)) &#123;</span><br><span class="line">                    <span class="comment">//处理邀请逻辑</span></span><br><span class="line">                    <span class="keyword">if</span> (inviter != <span class="keyword">null</span> &amp;&amp; UserRoleEnum.SELLER.getCode().equals(inviter.getRole()) &amp;&amp; UserRoleEnum.SELLER.getCode().equals(signUp.getRole())) &#123;</span><br><span class="line">                        <span class="comment">//处理商家邀请逻辑</span></span><br><span class="line">                        Long userId = signUp.getId();</span><br><span class="line">                        Long fatherId = inviterId;</span><br><span class="line">                        userService.handleSellerInvitation(userId, fatherId);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (inviter != <span class="keyword">null</span> &amp;&amp; UserRoleEnum.SHOWKER.getCode().equals(inviter.getRole()) &amp;&amp; UserRoleEnum.SHOWKER.getCode().equals(signUp.getRole())) &#123;</span><br><span class="line">                        <span class="comment">//处理拿手邀请奖励</span></span><br><span class="line">                        Long userId = signUp.getId();</span><br><span class="line">                        Long fatherId = inviterId;</span><br><span class="line">                        userService.handleShowkerInvitation(userId, fatherId);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            userService.evictUserCache(signUp.getId());</span><br><span class="line">            userService.evictUserCache(inviterId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> signUp;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>②、邀请逻辑：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">     * 处理拿手邀请逻辑</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    @Async</span><br><span class="line">    public void handleShowkerInvitation(Long userId, Long fatherId) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            User user = get(userId);</span><br><span class="line">            String channelSource = user.getChannelSource();</span><br><span class="line">            //大师傅</span><br><span class="line">            if (CHANNEL_SOURCE_DSF.equals(channelSource)) &#123;</span><br><span class="line">                //事务分离</span><br><span class="line">                //邀请关系的创建</span><br><span class="line">                showkerInvitationService.createShowkerInvitationRelation(userId, fatherId);</span><br><span class="line"></span><br><span class="line">                //处理大师傅的子孙</span><br><span class="line">                showkerInvitationService.handleAllSon(fatherId);</span><br><span class="line"></span><br><span class="line">                //大师傅的注册奖励</span><br><span class="line">                ShowkerExtension showkerExtension = showkerExtensionRepository.findByUserId(userId);</span><br><span class="line">                if (showkerExtension == null || !ShowkerExtension.RoleEnum.ROLE_FOREFATHER.getCode().equals(showkerExtension.getRole())) &#123;</span><br><span class="line">                    String k = rocketMQTransactionWrapper.createKey(userId + &quot;&quot;);</span><br><span class="line">                    JSONObject json = new JSONObject();</span><br><span class="line">                    json.put(&quot;userId&quot;, userId);</span><br><span class="line">                    json.put(&quot;fatherId&quot;, fatherId);</span><br><span class="line">                    MessageExt messageExt = rocketMQTransactionWrapper.createMessageExt(MQTagEnum.SHOWKER_SIGNUP_REWARD, k, json);</span><br><span class="line">                    rocketMQTransactionWrapper.sendSync(messageExt);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>③、邀请关系的创建</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">   * 创建邀请关系</span><br><span class="line">   */</span><br><span class="line">  @Override</span><br><span class="line">  public Long createShowkerInvitationRelation(Long userId, Long fatherId) throws Exception &#123;</span><br><span class="line">      if (userId != null &amp;&amp; fatherId != null) &#123;</span><br><span class="line">          ShowkerInvitation temp = showkerInvitationRepository.findByUserId(userId);</span><br><span class="line">          if (temp != null) &#123;</span><br><span class="line">              throw new CommonException(&quot;已经有一条邀请记录了！&quot;);</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">              AcquiredLockWrapper&lt;Long&gt; acquiredLockWrapper = () -&gt; &#123;</span><br><span class="line">                  ShowkerExtension fatherExtension = createShowkerExtension(fatherId);</span><br><span class="line">                  Integer fatherRole = fatherExtension.getRole();</span><br><span class="line">                  ShowkerInvitation fatherInvitation = showkerInvitationRepository.findByUserId(fatherId);</span><br><span class="line">                  ShowkerInvitation userInvitation = new ShowkerInvitation();</span><br><span class="line">                  userInvitation.setCreateTime(new Date());</span><br><span class="line">                  userInvitation.setUserId(userId);</span><br><span class="line">                  userInvitation.setFatherId(fatherId);</span><br><span class="line">                  userInvitation.setUserIsDivorced(false);</span><br><span class="line"></span><br><span class="line">                  if (fatherInvitation != null) &#123;</span><br><span class="line">                      Integer ancestor = fatherInvitation.getAncestor() == null ? 0 : fatherInvitation.getAncestor();</span><br><span class="line">                      userInvitation.setAncestor(ancestor + 1);</span><br><span class="line">                  &#125; else &#123;</span><br><span class="line">                      userInvitation.setAncestor(1);</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">                  if (ShowkerExtension.RoleEnum.ROLE_FOREFATHER.getCode().equals(fatherRole)) &#123;</span><br><span class="line">                      userInvitation.setDistance(1);</span><br><span class="line">                      userInvitation.setForefatherId(fatherId);</span><br><span class="line">                      userInvitation.setEternityForefatherId(fatherId);</span><br><span class="line">                  &#125; else &#123;</span><br><span class="line">                      if (fatherInvitation != null &amp;&amp; fatherInvitation.getForefatherId() != null) &#123;</span><br><span class="line">                          Integer distance = fatherInvitation.getDistance() == null ? 0 : fatherInvitation.getDistance();</span><br><span class="line">                          userInvitation.setDistance(distance + 1);</span><br><span class="line">                          userInvitation.setForefatherId(fatherInvitation.getForefatherId());</span><br><span class="line">                          userInvitation.setEternityForefatherId(fatherInvitation.getForefatherId());</span><br><span class="line">                      &#125; else &#123;</span><br><span class="line">                          userInvitation.setDistance(null);</span><br><span class="line">                          userInvitation.setForefatherId(null);</span><br><span class="line">                          userInvitation.setEternityForefatherId(null);</span><br><span class="line">                      &#125;</span><br><span class="line">                      showkerExtensionRepository.updateRoleById(fatherExtension.getId(), ShowkerExtension.RoleEnum.ROLE_FATHER.getCode());</span><br><span class="line">                  &#125;</span><br><span class="line">                  showkerInvitationRepository.save(userInvitation);</span><br><span class="line">                  return userInvitation.getForefatherId();</span><br><span class="line">              &#125;;</span><br><span class="line"></span><br><span class="line">              ShowkerInvitation fatherInvitation = showkerInvitationRepository.findByUserId(fatherId);</span><br><span class="line">              if (fatherInvitation != null) &#123;</span><br><span class="line">                  return distributedLock.lock(LockKeyUtils.getShowkerInvitationLockKey(fatherInvitation.getFatherId() + &quot;&quot;), acquiredLockWrapper);</span><br><span class="line">              &#125; else &#123;</span><br><span class="line">                  return acquiredLockWrapper.invokeAfterLockAcquire();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      return null;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>④、处理子孙的数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">     * 处理子孙的数据</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">//    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public void handleAllSon(Long forefatherId) &#123;</span><br><span class="line">        Long showkerInvitationLimit = 9999999999L;</span><br><span class="line">        SysConfig validSysConfig = sysConfigService.getValidSysConfig(UserConfigParam.SHOWKER_INVITATION_LIMIT);</span><br><span class="line">        if (validSysConfig != null) &#123;</span><br><span class="line">            showkerInvitationLimit = Long.parseLong(validSysConfig.getConfigValue());</span><br><span class="line">        &#125;</span><br><span class="line">        //确定父亲是不是祖先（查有多少个儿子）</span><br><span class="line">        ShowkerExtension fatherExtension = createShowkerExtension(forefatherId);</span><br><span class="line">        Long sonCount = showkerInvitationRepository.countByFatherId(forefatherId);</span><br><span class="line">        sonCount = sonCount == null ? 0L : sonCount;</span><br><span class="line">        if ((ShowkerExtension.RoleEnum.ROLE_FOREFATHER.getCode().equals(fatherExtension.getRole()) &amp;&amp; sonCount &gt;= showkerInvitationLimit &amp;&amp; sonCount &lt;= showkerInvitationLimit + 4) ||</span><br><span class="line">                ((!ShowkerExtension.RoleEnum.ROLE_FOREFATHER.getCode().equals(fatherExtension.getRole())) &amp;&amp; sonCount &gt;= showkerInvitationLimit)) &#123;</span><br><span class="line">            //如果是祖先则处理他的子孙</span><br><span class="line"></span><br><span class="line">            ShowkerInvitation byUserId = showkerInvitationRepository.findByUserId(forefatherId);</span><br><span class="line">            if (byUserId != null) &#123;</span><br><span class="line">                byUserId.setForefatherId(null);</span><br><span class="line">                byUserId.setDistance(0);</span><br><span class="line">                byUserId.setUserIsDivorced(true);</span><br><span class="line">                showkerInvitationRepository.save(byUserId);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Integer distance = 1;</span><br><span class="line">            try &#123;</span><br><span class="line">                handleSon(forefatherId, forefatherId, distance);</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                if (!ShowkerExtension.RoleEnum.ROLE_FOREFATHER.getCode().equals(fatherExtension.getRole())) &#123;</span><br><span class="line">                    User forefather = userRepository.findOne(forefatherId);</span><br><span class="line">                    momentQueue.push(Moment.TypeEnum.SHOWKER_BE_DSF, null, forefather.getPortraitPic(), forefather, null, null);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            showkerExtensionRepository.updateRoleById(fatherExtension.getId(), ShowkerExtension.RoleEnum.ROLE_FOREFATHER.getCode());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>⑤、大师傅的注册奖励（mq消息的消费）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line">package com.zhibi.xiuba.handler;</span><br><span class="line"></span><br><span class="line">import com.alibaba.fastjson.JSONObject;</span><br><span class="line">import com.alibaba.rocketmq.client.consumer.listener.ConsumeConcurrentlyContext;</span><br><span class="line">import com.alibaba.rocketmq.client.consumer.listener.ConsumeConcurrentlyStatus;</span><br><span class="line">import com.alibaba.rocketmq.common.message.MessageExt;</span><br><span class="line">import com.zhibi.xiuba.annotation.IMQConsumeHandler;</span><br><span class="line">import com.zhibi.xiuba.annotation.MQConsumeTag;</span><br><span class="line">import com.zhibi.xiuba.exception.CommonException;</span><br><span class="line">import com.zhibi.xiuba.lock.service.DistributedLock;</span><br><span class="line">import com.zhibi.xiuba.mq.MQTagEnum;</span><br><span class="line">import com.zhibi.xiuba.service.*;</span><br><span class="line">import com.zhibi.xiuba.service.impl.UserService;</span><br><span class="line">import com.zhibi.xiuba.user.spi.enums.LockKeyUtils;</span><br><span class="line">import com.zhibi.xiuba.user.spi.model.ShowkerInvitation;</span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 有关金额交易都放到mq消息队列中去</span><br><span class="line"> */</span><br><span class="line">@MQConsumeTag(&#123;</span><br><span class="line">        MQTagEnum.SHOWKER_SIGNUP_REWARD,</span><br><span class="line">        MQTagEnum.SHOWKER_BINDING_WANGWANG_REWARD,</span><br><span class="line">        MQTagEnum.SHOWKER_FINSH_SHOWKERTASK_REWARD,</span><br><span class="line">        MQTagEnum.SELLER_INVITATION_REWARD_FATHER,</span><br><span class="line">        MQTagEnum.SELLER_INVITATION_REWARD_FOREFATHER&#125;)</span><br><span class="line">@Service</span><br><span class="line">public class MoneyConsumeHandler implements IMQConsumeHandler &#123;</span><br><span class="line"></span><br><span class="line">    private final ITradingRecordService tradingRecordService;</span><br><span class="line"></span><br><span class="line">    private final DistributedLock distributedLock;</span><br><span class="line"></span><br><span class="line">    private final IShowkerInvitationService showkerInvitationService;</span><br><span class="line"></span><br><span class="line">    private final ISellerInvitationService sellerInvitationService;</span><br><span class="line"></span><br><span class="line">    private final IRecommendRewardService recommendRewardService;</span><br><span class="line"></span><br><span class="line">    private final IUserService userService;</span><br><span class="line"></span><br><span class="line">    private Logger logger = LoggerFactory.getLogger(this.getClass());</span><br><span class="line"></span><br><span class="line">    public MoneyConsumeHandler(ITradingRecordService tradingRecordService,</span><br><span class="line">                               DistributedLock distributedLock,</span><br><span class="line">                               IShowkerInvitationService showkerInvitationService,</span><br><span class="line">                               ISellerInvitationService sellerInvitationService,</span><br><span class="line">                               IRecommendRewardService recommendRewardService,</span><br><span class="line">                               UserService userService) &#123;</span><br><span class="line">        this.tradingRecordService = tradingRecordService;</span><br><span class="line">        this.distributedLock = distributedLock;</span><br><span class="line">        this.showkerInvitationService = showkerInvitationService;</span><br><span class="line">        this.sellerInvitationService = sellerInvitationService;</span><br><span class="line">        this.recommendRewardService = recommendRewardService;</span><br><span class="line">        this.userService = userService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public ConsumeConcurrentlyStatus consumeMessage(MessageExt messageExt, ConsumeConcurrentlyContext context) &#123;</span><br><span class="line">        JSONObject paramObject = JSONObject.parseObject(new String(messageExt.getBody()));</span><br><span class="line">        logger.info(&quot;receiveMsg:&#123;tag=&quot; + messageExt.getTags() + &quot;, content=&quot; + new String(messageExt.getBody()));</span><br><span class="line">        String tags = messageExt.getTags();</span><br><span class="line">        String msgId = messageExt.getMsgId();</span><br><span class="line">        MQTagEnum mqTagEnum = MQTagEnum.getEnumByCode(tags);</span><br><span class="line">        ConsumeConcurrentlyStatus consumeConcurrentlyStatus = ConsumeConcurrentlyStatus.RECONSUME_LATER;</span><br><span class="line">        switch (mqTagEnum) &#123;</span><br><span class="line">            case SHOWKER_SIGNUP_REWARD: &#123;</span><br><span class="line">                Long userId = paramObject.getLong(&quot;userId&quot;);</span><br><span class="line">                Long fatherId = paramObject.getLong(&quot;fatherId&quot;);</span><br><span class="line"></span><br><span class="line">                try &#123;</span><br><span class="line">                    ShowkerInvitation showkerInvitation = showkerInvitationService.findByUserId(userId);</span><br><span class="line">                    if (showkerInvitation != null &amp;&amp; showkerInvitation.getForefatherId() != null) &#123;</span><br><span class="line">                        distributedLock.lock(LockKeyUtils.getShowkerInvitationLockKey(showkerInvitation.getForefatherId() + &quot;&quot;),</span><br><span class="line">                                () -&gt; distributedLock.lock(LockKeyUtils.getShowkerInvitationLockKey(fatherId + &quot;&quot;),</span><br><span class="line">                                        () -&gt; showkerInvitationService.handleSignUpReward(showkerInvitation.getForefatherId(), fatherId, userId)));</span><br><span class="line"></span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        distributedLock.lock(LockKeyUtils.getShowkerInvitationLockKey(fatherId + &quot;&quot;),</span><br><span class="line">                                () -&gt; showkerInvitationService.handleSignUpReward(null, fatherId, userId));</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (showkerInvitation != null &amp;&amp; showkerInvitation.getForefatherId() != null) &#123;</span><br><span class="line">                        userService.evictUserCache(showkerInvitation.getForefatherId());</span><br><span class="line">                    &#125;</span><br><span class="line">                    userService.evictUserCache(fatherId);</span><br><span class="line">                    return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line"></span><br><span class="line">                &#125; catch (CommonException ce) &#123;</span><br><span class="line">                    if (&quot;dont_resubmit&quot;.equals(ce.getErrorCode())) &#123;</span><br><span class="line">                        return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        return ConsumeConcurrentlyStatus.RECONSUME_LATER;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    return ConsumeConcurrentlyStatus.RECONSUME_LATER;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            case SHOWKER_BINDING_WANGWANG_REWARD: &#123;</span><br><span class="line">                Long userId = paramObject.getLong(&quot;userId&quot;);</span><br><span class="line">                Long fatherId = paramObject.getLong(&quot;fatherId&quot;);</span><br><span class="line">                Long forefatherId = paramObject.getLong(&quot;forefatherId&quot;);</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (fatherId != null &amp;&amp; forefatherId != null) &#123;</span><br><span class="line">                        distributedLock.lock(LockKeyUtils.getShowkerInvitationLockKey(forefatherId + &quot;&quot;),</span><br><span class="line">                                () -&gt; distributedLock.lock(LockKeyUtils.getShowkerInvitationLockKey(fatherId + &quot;&quot;),</span><br><span class="line">                                        () -&gt; showkerInvitationService.handleBindingWangwangReward(forefatherId, fatherId, userId)));</span><br><span class="line">                    &#125; else if (fatherId != null) &#123;</span><br><span class="line">                        distributedLock.lock(LockKeyUtils.getShowkerInvitationLockKey(fatherId + &quot;&quot;),</span><br><span class="line">                                () -&gt; showkerInvitationService.handleBindingWangwangReward(null, fatherId, userId));</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    userService.evictUserCache(fatherId);</span><br><span class="line">                    userService.evictUserCache(forefatherId);</span><br><span class="line">                    return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">                &#125; catch (CommonException ce) &#123;</span><br><span class="line">                    if (&quot;dont_resubmit&quot;.equals(ce.getErrorCode())) &#123;</span><br><span class="line">                        return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        return ConsumeConcurrentlyStatus.RECONSUME_LATER;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    return ConsumeConcurrentlyStatus.RECONSUME_LATER;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            case SHOWKER_FINSH_SHOWKERTASK_REWARD: &#123;</span><br><span class="line">                Long showkerId = paramObject.getLong(&quot;showkerId&quot;);</span><br><span class="line">                Long showkerTaskId = paramObject.getLong(&quot;showkerTaskId&quot;);</span><br><span class="line">                boolean ifFirst = paramObject.getBoolean(&quot;ifFirst&quot;);</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (showkerId != null) &#123;</span><br><span class="line">                        userService.handleShowkerTaskReward(showkerId, ifFirst, showkerTaskId);</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        logger.info(&quot;SHOWKER_FINSH_SHOWKERTASK_REWARD：没有showkerId&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">                &#125; catch (CommonException ce) &#123;</span><br><span class="line">                    if (&quot;dont_resubmit&quot;.equals(ce.getErrorCode())) &#123;</span><br><span class="line">                        return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        return ConsumeConcurrentlyStatus.RECONSUME_LATER;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    return ConsumeConcurrentlyStatus.RECONSUME_LATER;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            case SELLER_INVITATION_REWARD_FATHER: &#123;</span><br><span class="line">                Long fatherId = paramObject.getLong(&quot;fatherId&quot;);</span><br><span class="line">                Long userId = paramObject.getLong(&quot;userId&quot;);</span><br><span class="line">                Long reward = paramObject.getLong(&quot;reward&quot;);</span><br><span class="line">                Long taskId = paramObject.getLong(&quot;taskId&quot;);</span><br><span class="line">                Long tradId = paramObject.getLong(&quot;tradId&quot;);</span><br><span class="line">                Integer initiatorType = paramObject.getInteger(&quot;initiatorType&quot;);</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (fatherId != null) &#123;</span><br><span class="line">                        distributedLock.lock(LockKeyUtils.getTradLockKeyUid(fatherId),</span><br><span class="line">                                () -&gt; sellerInvitationService.rewardSellerFather(userId, fatherId, reward, initiatorType, msgId, taskId, tradId));</span><br><span class="line">                        return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        logger.info(&quot;SELLER_INVITATION_REWARD_FATHER：没有fatherId&quot;);</span><br><span class="line">                        return ConsumeConcurrentlyStatus.RECONSUME_LATER;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; catch (CommonException ce) &#123;</span><br><span class="line">                    if (&quot;dont_resubmit&quot;.equals(ce.getErrorCode())) &#123;</span><br><span class="line">                        return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        return ConsumeConcurrentlyStatus.RECONSUME_LATER;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    return ConsumeConcurrentlyStatus.RECONSUME_LATER;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            case SELLER_INVITATION_REWARD_FOREFATHER: &#123;</span><br><span class="line">                Long forefatherId = paramObject.getLong(&quot;forefatherId&quot;);</span><br><span class="line">                Long reward = paramObject.getLong(&quot;reward&quot;);</span><br><span class="line">                Long userId = paramObject.getLong(&quot;userId&quot;);</span><br><span class="line">                Integer initiatorType = paramObject.getInteger(&quot;initiatorType&quot;);</span><br><span class="line">                Long taskId = paramObject.getLong(&quot;taskId&quot;);</span><br><span class="line">                Long tradId = paramObject.getLong(&quot;tradId&quot;);</span><br><span class="line">                try &#123;</span><br><span class="line">                    if (forefatherId != null) &#123;</span><br><span class="line">                        distributedLock.lock(LockKeyUtils.getTradLockKeyUid(forefatherId),</span><br><span class="line">                                () -&gt; sellerInvitationService.rewardSellerForefather(userId, forefatherId, reward, initiatorType, msgId, taskId, tradId));</span><br><span class="line">                        return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        logger.info(&quot;SELLER_INVITATION_REWARD_FATHER：没有forefatherId&quot;);</span><br><span class="line">                        return ConsumeConcurrentlyStatus.RECONSUME_LATER;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (CommonException ce) &#123;</span><br><span class="line">                    if (&quot;dont_resubmit&quot;.equals(ce.getErrorCode())) &#123;</span><br><span class="line">                        return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        return ConsumeConcurrentlyStatus.RECONSUME_LATER;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; catch (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    return ConsumeConcurrentlyStatus.RECONSUME_LATER;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            default:</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">        return consumeConcurrentlyStatus;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>⑥、SHOWKER_SIGNUP_REWARD消费逻辑：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    @Transactional(rollbackFor = Exception.class)</span><br><span class="line">    public boolean handleSignUpReward(Long forefatherId, Long fatherId, Long userId) throws CommonException &#123;</span><br><span class="line">        long rewardFather = 0L;</span><br><span class="line">        long rewardForefather = 0L;</span><br><span class="line">        long reward = 0;</span><br><span class="line">        Date now = new Date();</span><br><span class="line">        SysConfig validSysConfigFather = sysConfigService.getValidSysConfig(UserConfigParam.SHOWKER_INVITATION_REWARD_SIGN_UP_FATHER);</span><br><span class="line">        SysConfig validSysConfigForefather = sysConfigService.getValidSysConfig(UserConfigParam.SHOWKER_INVITATION_REWARD_SIGN_UP_FOREFATHER);</span><br><span class="line">        if (validSysConfigFather != null) &#123;</span><br><span class="line">            rewardFather = Long.parseLong(validSysConfigFather.getConfigValue());</span><br><span class="line">        &#125;</span><br><span class="line">        if (validSysConfigForefather != null) &#123;</span><br><span class="line">            rewardForefather = Long.parseLong(validSysConfigForefather.getConfigValue());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (fatherId != null &amp;&amp; rewardFather &gt; 0L) &#123;</span><br><span class="line">            ShowkerExtension showkerExtension = showkerExtensionRepository.findByUserId(fatherId);</span><br><span class="line">            User father = userRepository.findOne(fatherId);</span><br><span class="line">            UserAccount fatherAccount = father.getUserAccount();</span><br><span class="line">//            fatherAccount.setInvitationReward((fatherAccount.getInvitationReward() == null ? 0L : fatherAccount.getInvitationReward()) + rewardFather);</span><br><span class="line">//            fatherAccount.setLastUpdateTime(new Date());</span><br><span class="line">//            userAccountRepository.save(fatherAccount);</span><br><span class="line">            fatherAccount = complexEntityService.addInvitationReward(fatherId, fatherAccount.getId(), rewardFather);</span><br><span class="line"></span><br><span class="line">            ShowkerInvitationRewardLog temp1 = new ShowkerInvitationRewardLog();</span><br><span class="line">            temp1.setBeneficiaryId(fatherId);</span><br><span class="line">            temp1.setInitiatorId(userId);</span><br><span class="line">            temp1.setInitiatorType(ShowkerInvitationRewardLog.InitiatorTypeEnum.REWARD_SIGN_UP.getCode());</span><br><span class="line">            temp1.setOfferType(ShowkerInvitationRewardLog.OfferTypeEnum.REWARD_FATHER.getCode());</span><br><span class="line">            List&lt;ShowkerInvitationRewardLog&gt; all = showkerInvitationRewardLogRepository.findAll(Example.of(temp1));</span><br><span class="line">            if (all != null &amp;&amp; all.size() &gt; 0) &#123;</span><br><span class="line">                throw new CommonException(&quot;dont_resubmit&quot;, &quot;请不要重复奖励&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            try &#123;</span><br><span class="line">                momentQueue.push(Moment.TypeEnum.SHOWKER_REG_REWARD, null, father.getPortraitPic(), father, rewardFather,</span><br><span class="line">                        new JSONObject().fluentPut(Moment.TypeEnum.SHOWKER_REG_REWARD.getInfoKey(), userId)</span><br><span class="line">                                .fluentPut(&quot;sonNickname&quot;, PhoneUtil.hideNickname(userRepository.findOne(userId).getNickname())));</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ShowkerInvitationRewardLog showkerInvitationRewardLog = new ShowkerInvitationRewardLog();</span><br><span class="line">            showkerInvitationRewardLog.setBeneficiaryId(fatherId);</span><br><span class="line">            showkerInvitationRewardLog.setBeneficiaryRole(showkerExtension.getRole());</span><br><span class="line">            showkerInvitationRewardLog.setInitiatorId(userId);</span><br><span class="line">            showkerInvitationRewardLog.setInitiatorType(ShowkerInvitationRewardLog.InitiatorTypeEnum.REWARD_SIGN_UP.getCode());</span><br><span class="line">            showkerInvitationRewardLog.setOfferType(ShowkerInvitationRewardLog.OfferTypeEnum.REWARD_FATHER.getCode());</span><br><span class="line">            showkerInvitationRewardLog.setRewardFee(rewardFather);</span><br><span class="line">            showkerInvitationRewardLog.setCreateTime(now);</span><br><span class="line">            showkerInvitationRewardLogRepository.save(showkerInvitationRewardLog);</span><br><span class="line"></span><br><span class="line">            reward += rewardFather;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (forefatherId != null &amp;&amp; rewardForefather &gt; 0L) &#123;</span><br><span class="line">            ShowkerExtension showkerExtension = showkerExtensionRepository.findByUserId(forefatherId);</span><br><span class="line">            User forefather = userRepository.findOne(forefatherId);</span><br><span class="line">            UserAccount forefatherAccount = forefather.getUserAccount();</span><br><span class="line">//            forefatherAccount.setInvitationReward((forefatherAccount.getInvitationReward() == null ? 0L : forefatherAccount.getInvitationReward()) + rewardForefather);</span><br><span class="line">//            forefatherAccount.setLastUpdateTime(new Date());</span><br><span class="line">//            userAccountRepository.save(forefatherAccount);</span><br><span class="line">            forefatherAccount = complexEntityService.addInvitationReward(forefatherId, forefatherAccount.getId(), rewardForefather);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            ShowkerInvitationRewardLog temp2 = new ShowkerInvitationRewardLog();</span><br><span class="line">            temp2.setBeneficiaryId(forefatherId);</span><br><span class="line">            temp2.setInitiatorId(userId);</span><br><span class="line">            temp2.setInitiatorType(ShowkerInvitationRewardLog.InitiatorTypeEnum.REWARD_SIGN_UP.getCode());</span><br><span class="line">            temp2.setOfferType(ShowkerInvitationRewardLog.OfferTypeEnum.REWARD_FOREFATHER.getCode());</span><br><span class="line">            List&lt;ShowkerInvitationRewardLog&gt; all = showkerInvitationRewardLogRepository.findAll(Example.of(temp2));</span><br><span class="line">            if (all != null &amp;&amp; all.size() &gt; 0) &#123;</span><br><span class="line">                throw new CommonException(&quot;dont_resubmit&quot;, &quot;请不要重复奖励&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ShowkerInvitationRewardLog showkerInvitationRewardLog = new ShowkerInvitationRewardLog();</span><br><span class="line">            showkerInvitationRewardLog.setBeneficiaryId(forefatherId);</span><br><span class="line">            showkerInvitationRewardLog.setBeneficiaryRole(showkerExtension.getRole());</span><br><span class="line">            showkerInvitationRewardLog.setInitiatorId(userId);</span><br><span class="line">            showkerInvitationRewardLog.setInitiatorType(ShowkerInvitationRewardLog.InitiatorTypeEnum.REWARD_SIGN_UP.getCode());</span><br><span class="line">            showkerInvitationRewardLog.setOfferType(ShowkerInvitationRewardLog.OfferTypeEnum.REWARD_FOREFATHER.getCode());</span><br><span class="line">            showkerInvitationRewardLog.setRewardFee(rewardForefather);</span><br><span class="line">            showkerInvitationRewardLog.setCreateTime(now);</span><br><span class="line">            showkerInvitationRewardLogRepository.save(showkerInvitationRewardLog);</span><br><span class="line"></span><br><span class="line">            reward += rewardForefather;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (reward &gt; 0) &#123;</span><br><span class="line">            //平台账户交易记录</span><br><span class="line">            TradingRecord pt = new TradingRecord(Constants.PING_TAI_ID, null, -reward, now,</span><br><span class="line">                    TradingRecord.AccountChangeTypeEnum.XIUBA_RECORD.getCode(),</span><br><span class="line">                    0L, UserRoleEnum.PING_TAI.getCode(),</span><br><span class="line">                    TradingRecord.TradStateEnum.SUCCESS.getCode());</span><br><span class="line">            pt.setReferTradId(null);</span><br><span class="line">            pt.setReferUserId(userId);</span><br><span class="line">            pt.setTradTime(now);</span><br><span class="line">            pt.setFirstTradTime(now);</span><br><span class="line">            tradingRecordRepository.save(pt);</span><br><span class="line">            TradingRecordDetail trd = new TradingRecordDetail();</span><br><span class="line">            trd.setPlatform(TradingRecord.PlatformEnum.MOBILE_WAP_WECHAT.getCode());</span><br><span class="line">            trd.setCreateTime(now);</span><br><span class="line">            trd.setRole(UserRoleEnum.PING_TAI.getCode());</span><br><span class="line">            trd.setState(TradingRecordDetail.TradDetailStateEnum.SUCCESS.getCode());</span><br><span class="line">            trd.setTradAmount(-reward);</span><br><span class="line">            trd.setTradName(TradingRecordDetail.TradNameEnum.XIUBA_PLATFORM_PAY_FOR_INVITE_REWARDS_TO_WALLET_SHOWKER.getCode());</span><br><span class="line">            trd.setTradTime(now);</span><br><span class="line">            trd.setTradId(pt.getId());</span><br><span class="line">            trd.init(RandomStringUtils.random(5, true, true));</span><br><span class="line">            tradingRecordDetailRepository.save(trd);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div><div><div class="my_post_copyright"><script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script><script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script><script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script><p><span>本文标题:</span><a href="/2018/08/16/java/业务逻辑/三级分销/">三级分销</a></p><p><span>文章作者:</span><a href="/" title="访问 QinHe 的个人博客">QinHe</a></p><p><span>发布时间:</span>2018年08月16日 - 21:08</p><p><span>最后更新:</span>2018年08月16日 - 21:08</p></div><script>var clipboard=new Clipboard(".fa-clipboard");$(".fa-clipboard").click(function(){clipboard.on("success",function(){swal({title:"",text:"复制成功",icon:"success",showConfirmButton:!0})})})</script></div><div><div id="wechat_subscriber" style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center"> <img id="wechat_subscriber_qcode" src="/images/wechat-qcode.jpg" alt="QinHe wechat" style="width:200px;max-width:100%"><div>欢迎您扫一扫上面的微信公众号，订阅我的博客！</div></div></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/三级分销/" rel="tag"><i class="fa fa-tag"></i> 三级分销</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2018/08/16/java/业务逻辑/标签系统/" rel="next" title="标签系统"><i class="fa fa-chevron-left"></i> 标签系统</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2018/08/16/java/互联网技术/路由器和交换机/" rel="prev" title="路由器和交换机">路由器和交换机<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="addthis_inline_share_toolbox"><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5b3f66ffa7f921c2" async="async"></script></div></div></div></div><div class="comments" id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC8zNzkxMC8xNDQ0MA=="></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><section class="site-overview-wrap sidebar-panel sidebar-panel-active"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/portrait.jpg" alt="QinHe"><p class="site-author-name" itemprop="name">QinHe</p><p class="site-description motion-element" itemprop="description">我的征途是星辰大海</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">33</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">8</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">39</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/qinheJ" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:qinheJ@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://plus.google.com/qinheJ" target="_blank" title="Google"><i class="fa fa-fw fa-google"></i> Google</a></span><span class="links-of-author-item"><a href="https://twitter.com/yourname" target="_blank" title="Twitter"><i class="fa fa-fw fa-twitter"></i> Twitter</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="http://macshuo.com/" title="MacTalk" target="_blank">MacTalk</a></li><li class="links-of-blogroll-item"> <a href="http://example.com/" title="Title" target="_blank">Title</a></li></ul></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="copyright">&copy; <span itemprop="copyrightYear">2018</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">QinHe</span><div class="powered-by"><i class="fa fa-user-md"></i> <span id="busuanzi_container_site_pv">本站访客数:<span id="busuanzi_value_site_pv"></span></span></div></div><div class="theme-info"><div class="powered-by"></div> <span class="post-count">博客全站共46.1k字</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script><script type="text/javascript" src="/lib/three/three.min.js"></script><script type="text/javascript" src="/lib/three/three-waves.min.js"></script><script type="text/javascript" src="/lib/three/canvas_lines.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">!function(e,t){var n,c=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&((n=e.createElement(t)).src="https://cdn-city.livere.com/js/embed.dist.js",n.async=!0,c.parentNode.insertBefore(n,c))}(document,"script")</script><link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css"><script src="/lib/algolia-instant-search/instantsearch.min.js"></script><script src="/js/src/algolia-search.js?v=5.1.4"></script><canvas class="fireworks" style="position:fixed;left:0;top:0;z-index:1;pointer-events:none"></canvas><script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script><script type="text/javascript" src="/js/src/fireworks.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",display:{position:"right",width:100,height:150},mobile:{show:!1}})</script></body></html><script type="text/javascript" src="/js/src/love.js"></script>